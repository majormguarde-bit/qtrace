# Инструкция по развертыванию исправлений материалов

## Что исправлено

1. **Сохранение количества материалов** - количество теперь корректно сохраняется и отображается
2. **Выпадающий список единиц измерения** - вместо readonly поля теперь полноценный select
3. **Автоматическое заполнение единицы измерения** - при выборе материала единица измерения подставляется автоматически
4. **Корректное отображение при загрузке** - материалы и их количество правильно отображаются при редактировании шаблона

## Коммиты для развертывания

```bash
# Последние коммиты с исправлениями:
9d8a5d0 - Feature: Полная поддержка материалов в редакторе шаблонов
7704f6a - WIP: Добавлен выпадающий список для единиц измерения материалов
677e12d - Fix: Исправлено отображение количества материалов (локализация чисел)
6d01e97 - Fix: Добавлена полная поддержка материалов в редакторе шаблонов
```

## Шаги развертывания на хостинге

### 1. Создание резервной копии

```bash
# Подключитесь к серверу по SSH
ssh user@your-server.com

# Перейдите в директорию проекта
cd /path/to/skkp_project

# Создайте резервную копию базы данных
pg_dump -U postgres -d skkp_db > backup_$(date +%Y%m%d_%H%M%S).sql

# Создайте резервную копию файлов
tar -czf backup_files_$(date +%Y%m%d_%H%M%S).tar.gz .
```

### 2. Получение изменений из Git

```bash
# Убедитесь, что вы на правильной ветке
git branch

# Получите последние изменения
git fetch origin

# Переключитесь на ветку с исправлениями
git checkout feature/diagram-cytoscape

# Подтяните изменения
git pull origin feature/diagram-cytoscape
```

### 3. Применение изменений

```bash
# Активируйте виртуальное окружение
source venv/bin/activate  # для Linux/Mac
# или
venv\Scripts\activate  # для Windows

# Проверьте, нет ли новых зависимостей
pip install -r requirements.txt

# Проверьте миграции (для этих изменений миграции НЕ нужны)
python manage.py showmigrations

# Если есть непримененные миграции (не связанные с этими изменениями):
# python manage.py migrate

# Соберите статические файлы
python manage.py collectstatic --noinput
```

**Важно:** Для этих изменений миграции базы данных **НЕ требуются**, так как мы не изменяли модели. Все изменения только в логике обработки и отображения.

### 4. Перезапуск сервера

#### Для Passenger (рекомендуется)

```bash
# Создайте/обновите файл restart.txt
mkdir -p tmp
touch tmp/restart.txt
```

#### Для Gunicorn/uWSGI

```bash
# Перезапустите сервис
sudo systemctl restart gunicorn
# или
sudo systemctl restart uwsgi
```

#### Для разработки (manage.py runserver)

```bash
# Остановите сервер (Ctrl+C)
# Запустите снова
python manage.py runserver 0.0.0.0:8000
```

### 5. Проверка работоспособности

1. Откройте браузер и перейдите на сайт
2. Войдите как суперпользователь
3. Перейдите в раздел "Типовые шаблоны"
4. Откройте любой шаблон для редактирования
5. Проверьте:
   - ✅ Материалы отображаются с правильным количеством
   - ✅ Единица измерения - это выпадающий список
   - ✅ При выборе материала единица измерения заполняется автоматически
   - ✅ При сохранении количество материала сохраняется
6. Повторите проверку для локальных шаблонов (войдите как администратор тенанта)

### 6. Откат изменений (если что-то пошло не так)

```bash
# Вернитесь к предыдущему коммиту
git log --oneline -10  # найдите хеш коммита до изменений
git checkout <hash-коммита>

# Перезапустите сервер
touch tmp/restart.txt
```

## Измененные файлы

### Backend (Python)
- `dashboard/views.py` - добавлено API для единиц измерения, обновлено API материалов
- `dashboard/urls.py` - добавлен URL для API единиц измерения
- `customers/views.py` - обновлено API материалов, добавлена отладка

### Frontend (Templates)
- `dashboard/templates/dashboard/local_template_form.html` - выпадающий список единиц измерения, исправлена локализация чисел
- `customers/templates/customers/superuser_template_form.html` - выпадающий список единиц измерения, исправлена локализация чисел

### Документация
- `MATERIALS_FIX_SUMMARY.md` - описание исправлений
- `MATERIALS_DEPLOYMENT.md` - эта инструкция

## API изменения

### Новые endpoints

#### Для локальных шаблонов (тенанты):
- `GET /api/units/` - получение списка единиц измерения

#### Для типовых шаблонов (суперпользователь):
- `GET /api/customers/units-of-measure/` - получение списка единиц измерения (уже существовал)

### Обновленные endpoints

#### Материалы теперь возвращают:
```json
{
  "id": 1,
  "name": "Марка (QR-код)",
  "code": "QR001",
  "unit_id": 1,
  "unit_name": "Штука",
  "unit_abbreviation": "шт"
}
```

## Возможные проблемы и решения

### Проблема: Количество не отображается
**Решение:** Очистите кэш браузера (Ctrl+F5)

### Проблема: Единица измерения не заполняется автоматически
**Решение:** Проверьте консоль браузера (F12) на наличие ошибок JavaScript

### Проблема: 500 ошибка при сохранении
**Решение:** Проверьте логи сервера, возможно проблема с правами доступа к базе данных

### Проблема: Материалы не загружаются
**Решение:** Проверьте, что API `/api/materials/` и `/api/units/` доступны и возвращают данные

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи сервера
2. Проверьте консоль браузера (F12)
3. Создайте issue в репозитории с описанием проблемы и скриншотами

## Статус

✅ Изменения протестированы локально
✅ Изменения зафиксированы в Git
⏳ Ожидается развертывание на хостинге
