{% extends "customers/superuser_base.html" %}
{% load static %}

{% block title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤ - {{ template.name }}{% endblock %}
{% block header_title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤: {{ template.name }}{% endblock %}

{% block action_buttons %}
<a href="{% url 'superuser_templates' %}" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
</a>
{% endblock %}

{% block content %}
<style>
    #rightSidebar .card {
        flex-shrink: 0;
    }
    #rightSidebar .card-body {
        font-size: 0.9rem;
    }
    #rightSidebar .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
    }
    #rightSidebar .form-select-sm {
        font-size: 0.85rem;
    }
</style>
<div class="row" style="height: calc(100vh - 200px);">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–∏–∞–≥—Ä–∞–º–º–∞ -->
    <div class="col-lg-8">
        <div class="card h-100" style="display: flex; flex-direction: column;">
            <div class="card-header bg-light">
                <h5 class="mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞–ø–æ–≤ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)</h5>
            </div>
            <div class="card-body flex-grow-1" style="display: flex; flex-direction: column;">
                <!-- Cytoscape –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                <div id="cy" style="flex: 1; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;"></div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ -->
                <div id="statusMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="col-lg-4" style="overflow-y: auto; max-height: calc(100vh - 200px); padding-right: 0.5rem;" id="rightSidebar">
        <!-- –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong><br>
                    {% if total_duration_min == total_duration_max %}
                        <span class="badge bg-info">{{ total_duration_min }} —á–∞—Å–æ–≤</span>
                    {% else %}
                        <span class="badge bg-info">{{ total_duration_min }}-{{ total_duration_max }} —á–∞—Å–æ–≤</span>
                    {% endif %}
                </div>
                <div>
                    <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:</strong><br>
                    {% for pos in unique_positions %}
                        <span class="badge bg-secondary">{{ pos }}</span>
                    {% empty %}
                        <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º–æ–π -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h6>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="editModeToggle">
                    <label class="form-check-label" for="editModeToggle">
                        <small>–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π</small>
                    </label>
                </div>
                
                <div id="editModeInfo" class="text-muted" style="display: none;">
                    <small>
                        <strong>–ê–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º:</strong><br>
                        ‚Ä¢ Shift+–ö–ª–∏–∫ - –Ω–∞—á–∞—Ç—å —Å–≤—è–∑—å<br>
                        ‚Ä¢ –ö–ª–∏–∫ - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–≤—è–∑—å<br>
                        ‚Ä¢ Escape - –æ—Ç–º–µ–Ω–∞
                    </small>
                </div>
                
                <hr class="my-2">
                
                <small class="text-muted d-block">
                    <strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong><br>
                    ‚Ä¢ –ö–æ–ª–µ—Å–æ –º—ã—à–∏ - –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ<br>
                    ‚Ä¢ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ - –ø–∞–Ω–æ—Ä–∞–º–∞<br>
                    ‚Ä¢ –ö–ª–∏–∫ –Ω–∞ –±–ª–æ–∫ - –≤—ã–±—Ä–∞—Ç—å<br>
                    ‚Ä¢ Delete - —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å<br>
                    ‚Ä¢ Ctrl+R - —Å–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
                </small>
            </div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–º -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–º</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'superuser_template_edit' template.id %}" class="row g-2">
                    {% csrf_token %}
                    <div class="col-12">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø:</label>
                        <select name="stage_id" class="form-select form-select-sm" required id="stageSelect">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
                            {% for stage in all_stages %}
                            <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç—Ç–∞–ø:</label>
                        <select name="parent_stage_id" class="form-select form-select-sm" id="parentSelect">
                            <option value="">-- –ù–µ—Ç –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è --</option>
                            {% for stage in all_stages %}
                            <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–¥–æ–ª–∂–Ω–æ—Å—Ç—å):</label>
                        <select name="position_id" class="form-select form-select-sm" id="positionSelect">
                            <option value="">-- –ù–µ —É–∫–∞–∑–∞–Ω–∞ --</option>
                            {% for position in positions %}
                            <option value="{{ position.id }}">{{ position.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" name="action" value="set_parent" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-check-circle me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-canvas@3.0.1/build/cytoscape-canvas.cjs.js"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –æ —ç—Ç–∞–ø–∞—Ö
const stagesDataJson = '{{ stages_json|escapejs }}';
const stagesData = stagesDataJson ? JSON.parse(stagesDataJson) : [];

// –î–∞–Ω–Ω—ã–µ –æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö
const positionsDataJson = '{{ positions_json|escapejs }}';
const positionsData = positionsDataJson ? JSON.parse(positionsDataJson) : [];

document.addEventListener('DOMContentLoaded', function() {
    const templateId = parseInt('{{ template.id }}');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π
    let editMode = false;
    let isDrawing = false;
    let sourceNode = null;
    let tempEdge = null;
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Cytoscape
    const elements = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–∞—Ä—Ç"
    elements.push({
        data: { id: 'start', label: 'üü¢ –°—Ç–∞—Ä—Ç' },
        classes: 'start'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã —ç—Ç–∞–ø–æ–≤
    stagesData.forEach(stage => {
        const stageName = stage.sequence_number + '. ' + stage.name;
        const position = stage.position || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        const duration = stage.duration;
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Ç–∫—É –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ (–≤—Ä–µ–º—è –±—É–¥–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–µ)
        const label = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' + stageName + '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' + position;
        
        elements.push({
            data: {
                id: 'stage_' + stage.id,
                label: label,
                stageName: stageName,
                position: position,
                duration: duration
            }
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–æ–ø"
    elements.push({
        data: { id: 'stop', label: 'üî¥ –°—Ç–æ–ø' },
        classes: 'stop'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Å–≤—è–∑–∏)
    // –û—Ç –°—Ç–∞—Ä—Ç–∞ –∫ –ø–µ—Ä–≤–æ–º—É —ç—Ç–∞–ø—É
    if (stagesData.length > 0) {
        elements.push({
            data: {
                id: 'edge_start_' + stagesData[0].id,
                source: 'start',
                target: 'stage_' + stagesData[0].id
            }
        });
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —ç—Ç–∞–ø–æ–≤, —Å–æ–µ–¥–∏–Ω—è–µ–º –°—Ç–∞—Ä—Ç —Å–æ –°—Ç–æ–ø–æ–º
        elements.push({
            data: {
                id: 'edge_start_stop',
                source: 'start',
                target: 'stop'
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ –¥–ª—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
    stagesData.forEach(stage => {
        if (stage.parent_stage_id) {
            elements.push({
                data: {
                    id: 'edge_' + stage.parent_stage_id + '_' + stage.id,
                    source: 'stage_' + stage.parent_stage_id,
                    target: 'stage_' + stage.id
                }
            });
        }
    });
    
    // –û—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ –∫ –°—Ç–æ–ø—É
    if (stagesData.length > 0) {
        const lastStage = stagesData[stagesData.length - 1];
        elements.push({
            data: {
                id: 'edge_' + lastStage.id + '_stop',
                source: 'stage_' + lastStage.id,
                target: 'stop'
            }
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Cytoscape
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': '#007bff',
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': 20,
                    'font-weight': 'bold',
                    'color': 'white',
                    'border-width': 2,
                    'border-color': '#0056b3',
                    'padding': '20px',
                    'text-wrap': 'wrap',
                    'text-max-width': '220px',
                    'shape': 'rectangle',
                    'width': '280px',
                    'height': '160px',
                    'cursor': 'pointer',
                    'line-height': 1.2
                }
            },
            {
                selector: 'node:hover',
                style: {
                    'border-width': 3,
                    'border-color': '#ff9800',
                    'box-shadow': '0 0 15px rgba(255, 152, 0, 0.6)'
                }
            },
            {
                selector: 'node.start',
                style: {
                    'background-color': '#28a745',
                    'border-color': '#1e7e34',
                    'shape': 'ellipse',
                    'width': 120,
                    'height': 120,
                    'font-size': 18,
                    'font-weight': 'bold'
                }
            },
            {
                selector: 'node.stop',
                style: {
                    'background-color': '#155724',
                    'border-color': '#0d3818',
                    'shape': 'ellipse',
                    'width': 120,
                    'height': 120,
                    'font-size': 18,
                    'font-weight': 'bold'
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'background-color': '#ffc107',
                    'color': '#000',
                    'border-color': '#ff9800',
                    'border-width': 3
                }
            },
            {
                selector: 'edge',
                style: {
                    'line-color': '#0056b3',
                    'target-arrow-color': '#0056b3',
                    'target-arrow-shape': 'triangle',
                    'arrow-scale': 2,
                    'width': 3,
                    'curve-style': 'bezier',
                    'opacity': 0.8
                }
            },
            {
                selector: 'edge:hover',
                style: {
                    'line-color': '#ff9800',
                    'target-arrow-color': '#ff9800',
                    'width': 4,
                    'opacity': 1
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#ffc107',
                    'target-arrow-color': '#ffc107',
                    'width': 4,
                    'opacity': 1
                }
            }
        ],
        layout: {
            name: 'breadthfirst',
            directed: true,
            animate: true,
            animationDuration: 500,
            spacingFactor: 1.5,
            roots: '#start'
        }
    });
    
    // –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º
    const canvas = cy.container().querySelector('canvas');
    const originalDraw = cy.renderer().drawNode;
    
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ä–∏—Å–æ–≤–∞–Ω–∏—è —É–∑–ª–æ–≤
    cy.on('render', function() {
        const ctx = cy.scratch().canvasContext;
        if (!ctx) return;
        
        // –†–∏—Å—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞
        cy.nodes().forEach(node => {
            if (node.id().startsWith('stage_')) {
                const pos = node.renderedPosition();
                const w = node.width();
                const h = node.height();
                
                // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∞–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞
                const x = pos.x + w / 2;
                const y = pos.y - h / 2;
                
                // –†–∞–∑–º–µ—Ä—ã —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
                const boxW = 80;
                const boxH = 40;
                const offset = 0.2; // 20% –≤—ã—Å—Ç—É–ø–∞–Ω–∏—è
                
                // –†–∏—Å—É–µ–º —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–º–∏ –∫—Ä–∞—è–º–∏
                ctx.fillStyle = '#87ceeb';
                ctx.strokeStyle = '#4a9fd8';
                ctx.lineWidth = 2;
                
                // –†–∏—Å—É–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                const radius = 15;
                ctx.beginPath();
                ctx.moveTo(x - boxW / 2 + radius, y - boxH / 2 - offset * h);
                ctx.lineTo(x + boxW / 2 - radius, y - boxH / 2 - offset * h);
                ctx.quadraticCurveTo(x + boxW / 2, y - boxH / 2 - offset * h, x + boxW / 2, y - boxH / 2 - offset * h + radius);
                ctx.lineTo(x + boxW / 2, y + boxH / 2 - offset * h - radius);
                ctx.quadraticCurveTo(x + boxW / 2, y + boxH / 2 - offset * h, x + boxW / 2 - radius, y + boxH / 2 - offset * h);
                ctx.lineTo(x - boxW / 2 + radius, y + boxH / 2 - offset * h);
                ctx.quadraticCurveTo(x - boxW / 2, y + boxH / 2 - offset * h, x - boxW / 2, y + boxH / 2 - offset * h - radius);
                ctx.lineTo(x - boxW / 2, y - boxH / 2 - offset * h + radius);
                ctx.quadraticCurveTo(x - boxW / 2, y - boxH / 2 - offset * h, x - boxW / 2 + radius, y - boxH / 2 - offset * h);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // –†–∏—Å—É–µ–º —Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(node.data('duration'), x, y - offset * h);
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —É–∑–µ–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        const nodeId = node.id();
        
        // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–∞–∂–∞—Ç Shift
        if (editMode && evt.originalEvent.shiftKey) {
            if (nodeId === 'start' || nodeId === 'stop') {
                showStatus('–ù–µ–ª—å–∑—è —Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —É–∑–ª–æ–≤', 'error');
                return;
            }
            
            if (!isDrawing) {
                // –ù–∞—á–∏–Ω–∞–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤—è–∑—å
                sourceNode = node;
                isDrawing = true;
                node.style('border-width', 4);
                node.style('border-color', '#ff9800');
                showStatus('–°–≤—è–∑—å –Ω–∞—á–∞—Ç–∞. –ö–ª–∏–∫ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –±–ª–æ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', 'info');
            } else {
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏
                const targetNode = node;
                const sourceId = sourceNode.id();
                const targetId = targetNode.id();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å–≤—è–∑—å
                if (sourceId === targetId) {
                    showStatus('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è', 'error');
                    cancelDrawing();
                    return;
                }
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —ç—Ç–∞–ø–æ–≤
                const sourceStageId = sourceId === 'start' ? 'start' : sourceId.replace('stage_', '');
                const targetStageId = targetId === 'stop' ? 'stop' : targetId.replace('stage_', '');
                
                // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π —É–∑–µ–ª - —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —ç—Ç–∞–ø
                if (targetId !== 'start' && targetId !== 'stop') {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏
                    document.getElementById('stageSelect').value = targetStageId;
                    document.getElementById('parentSelect').value = sourceStageId === 'start' ? '' : sourceStageId;
                    
                    showStatus('–°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
                } else {
                    showStatus('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É —É–∑–ª—É', 'error');
                }
                
                cancelDrawing();
            }
            return;
        }
        
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –≤—ã–±–æ—Ä –±–ª–æ–∫–∞
        if (nodeId === 'start' || nodeId === 'stop') {
            return;
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —ç—Ç–∞–ø–∞
        const stageId = nodeId.replace('stage_', '');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º—É
        document.getElementById('stageSelect').value = stageId;
        
        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å
        const stage = stagesData.find(s => s.id == stageId);
        if (stage) {
            if (stage.parent_stage_id) {
                document.getElementById('parentSelect').value = stage.parent_stage_id;
            } else {
                document.getElementById('parentSelect').value = '';
            }
            
            if (stage.position_id) {
                document.getElementById('positionSelect').value = stage.position_id;
            } else {
                document.getElementById('positionSelect').value = '';
            }
        }
        
        showStatus('–≠—Ç–∞–ø –≤—ã–±—Ä–∞–Ω. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"', 'info');
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    function cancelDrawing() {
        if (sourceNode) {
            sourceNode.style('border-width', 2);
            sourceNode.style('border-color', '#0056b3');
        }
        isDrawing = false;
        sourceNode = null;
        if (tempEdge) {
            cy.remove(tempEdge);
            tempEdge = null;
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (isDrawing) {
                cancelDrawing();
                showStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
            }
        }
        
        // Ctrl+R - —Å–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            cy.fit();
            showStatus('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω', 'info');
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('editModeToggle').addEventListener('change', function(e) {
        editMode = e.target.checked;
        document.getElementById('editModeInfo').style.display = editMode ? 'block' : 'none';
        
        if (editMode) {
            showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. Shift+–ö–ª–∏–∫ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π', 'info');
            cy.style().selector('node').style('cursor', 'crosshair').update();
        } else {
            cancelDrawing();
            showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
            cy.style().selector('node').style('cursor', 'pointer').update();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π (Delete)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Delete') {
            const selected = cy.$(':selected');
            if (selected.length > 0) {
                const element = selected[0];
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–±—Ä–æ (—Å—Ç—Ä–µ–ª–∫–∞)
                if (element.isEdge()) {
                    const sourceId = element.source().id();
                    const targetId = element.target().id();
                    
                    // –ù–µ —É–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–≤—è–∑–∏ (Start –∏ Stop)
                    if ((sourceId === 'start' || sourceId === 'stop' || 
                         targetId === 'start' || targetId === 'stop')) {
                        showStatus('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–≤—è–∑–∏', 'error');
                        return;
                    }
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —ç—Ç–∞–ø–∞ –∏–∑ targetId
                    const stageId = targetId.replace('stage_', '');
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑—å —Å –¥–∏–∞–≥—Ä–∞–º–º—ã
                    cy.remove(element);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è
                    document.getElementById('stageSelect').value = stageId;
                    document.getElementById('parentSelect').value = '';
                    
                    showStatus('–°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞ —Å –¥–∏–∞–≥—Ä–∞–º–º—ã. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
                }
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const stageId = document.getElementById('stageSelect').value;
            const parentId = document.getElementById('parentSelect').value;
            
            if (!stageId) {
                e.preventDefault();
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø', 'error');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å–≤—è–∑—å –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º—É –≤–∏–∑—É–∞–ª—å–Ω–æ
            const targetNodeId = 'stage_' + stageId;
            const sourceNodeId = parentId ? 'stage_' + parentId : 'start';
            const edgeId = 'edge_' + (parentId || 'start') + '_' + stageId;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è —Å–≤—è–∑—å
            const existingEdge = cy.$('#' + edgeId);
            if (existingEdge.length === 0) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å–≤—è–∑—å
                cy.add({
                    data: {
                        id: edgeId,
                        source: sourceNodeId,
                        target: targetNodeId
                    }
                });
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–æ–≤—É—é —Å–≤—è–∑—å
                cy.$('#' + edgeId).style('line-color', '#28a745');
                cy.$('#' + edgeId).style('target-arrow-color', '#28a745');
                cy.$('#' + edgeId).style('width', 4);
                
                showStatus('–°–≤—è–∑—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º—É. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'success');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                showStatus('–ü–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...', 'success');
                setTimeout(() => location.reload(), 1500);
            }, 500);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        const alertClass = type === 'success' ? 'success' : (type === 'error' ? 'danger' : 'info');
        statusDiv.innerHTML = `<div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            const alert = statusDiv.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
