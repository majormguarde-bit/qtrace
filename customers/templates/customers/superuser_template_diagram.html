{% extends "customers/superuser_base.html" %}
{% load static %}

{% block title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤ - {{ template.name }}{% endblock %}
{% block header_title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤: {{ template.name }}{% endblock %}

{% block action_buttons %}
<a href="{% url 'superuser_templates' %}" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card card-table">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞–ø–æ–≤ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)</h5>
                    <small class="text-muted">üí° –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –±–ª–æ–∫–∏, –Ω–∞–∂–∏–º–∞–π—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏</small>
                </div>
            </div>
            <div class="card-body">
                {% csrf_token %}
                
                <!-- Cytoscape –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                <div id="cy" style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;"></div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ -->
                <div id="statusMessage" class="mt-3"></div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ–º -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ–º —ç—Ç–∞–ø–æ–≤</h6>
                    <form method="post" action="{% url 'superuser_template_edit' template.id %}" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-5">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø:</label>
                            <select name="stage_id" class="form-select" required id="stageSelect">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
                                {% for stage in all_stages %}
                                <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç—Ç–∞–ø:</label>
                            <select name="parent_stage_id" class="form-select" id="parentSelect">
                                <option value="">-- –ù–µ—Ç –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è --</option>
                                {% for stage in all_stages %}
                                <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" name="action" value="set_parent" class="btn btn-primary w-100">
                                <i class="bi bi-link me-1"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-cose-bilkent/4.1.0/cytoscape-cose-bilkent.min.js"></script>

<script>
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º layout –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
if (typeof coseBilkent !== 'undefined') {
    cytoscape.use(coseBilkent);
}

// –î–∞–Ω–Ω—ã–µ –æ —ç—Ç–∞–ø–∞—Ö
const stagesDataJson = '{{ stages_json|escapejs }}';
const stagesData = stagesDataJson ? JSON.parse(stagesDataJson) : [];

document.addEventListener('DOMContentLoaded', function() {
    const templateId = parseInt('{{ template.id }}');
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Cytoscape
    const elements = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–∞—Ä—Ç"
    elements.push({
        data: { id: 'start', label: 'üü¢ –°—Ç–∞—Ä—Ç' },
        classes: 'start'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã —ç—Ç–∞–ø–æ–≤
    stagesData.forEach(stage => {
        elements.push({
            data: {
                id: 'stage_' + stage.id,
                label: stage.sequence_number + '. ' + stage.name + '\n' + (stage.position || '–ù–µ —É–∫–∞–∑–∞–Ω–∞') + '\n' + stage.duration
            }
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–æ–ø"
    elements.push({
        data: { id: 'stop', label: 'üî¥ –°—Ç–æ–ø' },
        classes: 'stop'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Å–≤—è–∑–∏)
    // –û—Ç –°—Ç–∞—Ä—Ç–∞ –∫ –ø–µ—Ä–≤–æ–º—É —ç—Ç–∞–ø—É
    if (stagesData.length > 0) {
        elements.push({
            data: {
                id: 'edge_start_' + stagesData[0].id,
                source: 'start',
                target: 'stage_' + stagesData[0].id
            }
        });
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —ç—Ç–∞–ø–æ–≤, —Å–æ–µ–¥–∏–Ω—è–µ–º –°—Ç–∞—Ä—Ç —Å–æ –°—Ç–æ–ø–æ–º
        elements.push({
            data: {
                id: 'edge_start_stop',
                source: 'start',
                target: 'stop'
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ –¥–ª—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
    stagesData.forEach(stage => {
        if (stage.parent_stage_id) {
            elements.push({
                data: {
                    id: 'edge_' + stage.parent_stage_id + '_' + stage.id,
                    source: 'stage_' + stage.parent_stage_id,
                    target: 'stage_' + stage.id
                }
            });
        }
    });
    
    // –û—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ –∫ –°—Ç–æ–ø—É
    if (stagesData.length > 0) {
        const lastStage = stagesData[stagesData.length - 1];
        elements.push({
            data: {
                id: 'edge_' + lastStage.id + '_stop',
                source: 'stage_' + lastStage.id,
                target: 'stop'
            }
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Cytoscape
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': '#007bff',
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': 11,
                    'font-weight': 'bold',
                    'color': 'white',
                    'border-width': 2,
                    'border-color': '#0056b3',
                    'padding': '10px',
                    'text-wrap': 'wrap',
                    'text-max-width': '150px',
                    'shape': 'rectangle',
                    'min-width': '80px',
                    'min-height': '60px'
                }
            },
            {
                selector: 'node.start',
                style: {
                    'background-color': '#28a745',
                    'border-color': '#1e7e34',
                    'shape': 'ellipse',
                    'width': 100,
                    'height': 100
                }
            },
            {
                selector: 'node.stop',
                style: {
                    'background-color': '#dc3545',
                    'border-color': '#bb2d3b',
                    'shape': 'ellipse',
                    'width': 100,
                    'height': 100
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'background-color': '#ffc107',
                    'color': '#000',
                    'border-color': '#ff9800',
                    'border-width': 3
                }
            },
            {
                selector: 'edge',
                style: {
                    'line-color': '#0056b3',
                    'target-arrow-color': '#0056b3',
                    'target-arrow-shape': 'triangle',
                    'arrow-scale': 1.5,
                    'width': 2,
                    'curve-style': 'bezier'
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#ffc107',
                    'target-arrow-color': '#ffc107',
                    'width': 3
                }
            }
        ],
        layout: {
            name: 'cose-bilkent',
            directed: true,
            animate: true,
            animationDuration: 500,
            nodeSeparation: 100,
            edgeElasticity: 0.45,
            nestingFactor: 0.1,
            gravity: 0.25,
            numIter: 2500,
            tile: true,
            tilingPaddingVertical: 10,
            tilingPaddingHorizontal: 10,
            gravityRangeCompound: 1.5,
            gravityCompound: 1.0,
            gravityRange: 3.8,
            initialEnergyOnIncremental: 0.3
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —É–∑–µ–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        const nodeId = node.id();
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –°—Ç–∞—Ä—Ç –∏ –°—Ç–æ–ø
        if (nodeId === 'start' || nodeId === 'stop') {
            return;
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —ç—Ç–∞–ø–∞
        const stageId = nodeId.replace('stage_', '');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º—É
        document.getElementById('stageSelect').value = stageId;
        
        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è
        const stage = stagesData.find(s => s.id == stageId);
        if (stage && stage.parent_stage_id) {
            document.getElementById('parentSelect').value = stage.parent_stage_id;
        } else {
            document.getElementById('parentSelect').value = '';
        }
        
        // –°–∫—Ä–æ–ª–ª–∏–º –∫ —Ñ–æ—Ä–º–µ
        document.querySelector('.mt-4').scrollIntoView({ behavior: 'smooth' });
        
        showStatus('‚úì –≠—Ç–∞–ø –≤—ã–±—Ä–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"', 'info');
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const stageId = document.getElementById('stageSelect').value;
            const parentId = document.getElementById('parentSelect').value;
            
            if (!stageId) {
                e.preventDefault();
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                showStatus('‚úì –ü–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                setTimeout(() => location.reload(), 1500);
            }, 500);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        const alertClass = type === 'success' ? 'success' : (type === 'error' ? 'danger' : 'info');
        statusDiv.innerHTML = `<div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
});
</script>
{% endblock %}
