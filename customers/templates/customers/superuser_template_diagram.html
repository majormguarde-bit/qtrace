{% extends "customers/superuser_base.html" %}
{% load static %}

{% block title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤ - {{ template.name }}{% endblock %}
{% block header_title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤: {{ template.name }}{% endblock %}

{% block action_buttons %}
<a href="{% url 'superuser_templates' %}" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
</a>
{% endblock %}

{% block content %}
<style>
    #rightSidebar .card {
        flex-shrink: 0;
    }
    #rightSidebar .card-body {
        font-size: 0.9rem;
    }
    #rightSidebar .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
    }
    #rightSidebar .form-select-sm {
        font-size: 0.85rem;
    }
    
    /* Print styles */
    @media print {
        body {
            margin: 0;
            padding: 0;
        }
        .row {
            height: auto !important;
        }
        .col-lg-4 {
            display: none !important;
        }
        .col-lg-8 {
            max-width: 100% !important;
            flex: 0 0 100% !important;
        }
        .card {
            border: none !important;
            box-shadow: none !important;
        }
        .card-header {
            display: none !important;
        }
        .card-body {
            padding: 0 !important;
        }
        #cy {
            border: none !important;
            background: white !important;
            height: 973px !important;
            width: 644px !important;
            margin: 20mm !important;
        }
        #statusMessage {
            display: none !important;
        }
    }
</style>
<div class="row" style="height: calc(100vh - 200px);">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–∏–∞–≥—Ä–∞–º–º–∞ -->
    <div class="col-lg-8">
        <div class="card h-100" style="display: flex; flex-direction: column;">
            <div class="card-header bg-light">
                <h5 class="mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞–ø–æ–≤ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)</h5>
            </div>
            <div class="card-body flex-grow-1" style="display: flex; flex-direction: column;">
                <!-- Cytoscape –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                <div id="cy" style="flex: 1; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;"></div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ -->
                <div id="statusMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="col-lg-4" style="overflow-y: auto; max-height: calc(100vh - 200px); padding-right: 0.5rem;" id="rightSidebar">
        <!-- –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong><br>
                    {% if total_duration_min == total_duration_max %}
                        <span class="badge bg-info">{{ total_duration_min }} —á–∞—Å–æ–≤</span>
                    {% else %}
                        <span class="badge bg-info">{{ total_duration_min }}-{{ total_duration_max }} —á–∞—Å–æ–≤</span>
                    {% endif %}
                </div>
                <div>
                    <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:</strong><br>
                    {% for pos in unique_positions %}
                        <span class="badge bg-secondary">{{ pos }}</span>
                    {% empty %}
                        <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–º -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–º</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'superuser_template_edit' template.id %}" class="row g-2">
                    {% csrf_token %}
                    <div class="col-12">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø:</label>
                        <select name="stage_id" class="form-select form-select-sm" required id="stageSelect">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
                            {% for stage in all_stages %}
                            <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç—Ç–∞–ø:</label>
                        <select name="parent_stage_id" class="form-select form-select-sm" id="parentSelect">
                            <option value="">-- –ù–µ—Ç –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è --</option>
                            {% for stage in all_stages %}
                            <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–¥–æ–ª–∂–Ω–æ—Å—Ç—å):</label>
                        <select name="position_id" class="form-select form-select-sm" id="positionSelect">
                            <option value="">-- –ù–µ —É–∫–∞–∑–∞–Ω–∞ --</option>
                            {% for position in positions %}
                            <option value="{{ position.id }}">{{ position.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–í—Ä–µ–º—è (—á–∞—Å–æ–≤):</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" id="durationMin" placeholder="–ú–∏–Ω" min="1" value="1">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" id="durationMax" placeholder="–ú–∞–∫—Å" min="1" value="1">
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-sm w-100" id="submitStageForm">
                            <i class="bi bi-check-circle me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
                
                <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–∞–ø–æ–≤ -->
                <div class="mt-3 pt-3 border-top">
                    <button type="button" class="btn btn-success btn-sm w-100 mb-2" id="addStageBtn">
                        <i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø
                    </button>
                    <button type="button" class="btn btn-danger btn-sm w-100" id="deleteStageBtn" disabled>
                        <i class="bi bi-trash me-1"></i> –£–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø
                    </button>
                </div>
                
                <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–∏ –∫ Stop -->
                <div id="saveConnectionToStop" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                    <p class="small text-muted mb-2">–ù–æ–≤–∞—è —Å–≤—è–∑—å –∫ –°—Ç–æ–ø:</p>
                    <button type="button" class="btn btn-success btn-sm w-100" id="confirmSaveConnection">
                        <i class="bi bi-check-circle me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤—è–∑—å
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm w-100 mt-2" id="cancelSaveConnection">
                        <i class="bi bi-x-circle me-1"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ -->
        <div class="card mb-3">
            <div class="card-body">
                <button type="button" class="btn btn-primary btn-sm w-100" id="printDiagramBtn">
                    <i class="bi bi-printer me-1"></i> –ü–µ—á–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã
                </button>
            </div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏ -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏</h6>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="editModeToggle">
                    <label class="form-check-label" for="editModeToggle">
                        <small>–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π</small>
                    </label>
                </div>
                
                <div id="editModeInfo" class="text-muted" style="display: none;">
                    <small>
                        <strong>–ê–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º:</strong><br>
                        ‚Ä¢ Shift+–ö–ª–∏–∫ –Ω–∞ –±–ª–æ–∫ - –Ω–∞—á–∞—Ç—å —Å–≤—è–∑—å<br>
                        ‚Ä¢ Shift+–ö–ª–∏–∫ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –±–ª–æ–∫ - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–≤—è–∑—å<br>
                        ‚Ä¢ Escape - –æ—Ç–º–µ–Ω–∞
                    </small>
                </div>
                
                <hr class="my-2">
                
                <small class="text-muted d-block">
                    <strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong><br>
                    ‚Ä¢ –ö–æ–ª–µ—Å–æ –º—ã—à–∏ - –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ<br>
                    ‚Ä¢ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ - –ø–∞–Ω–æ—Ä–∞–º–∞<br>
                    ‚Ä¢ –ö–ª–∏–∫ –Ω–∞ –±–ª–æ–∫ - –≤—ã–±—Ä–∞—Ç—å<br>
                    ‚Ä¢ Delete - —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å<br>
                    ‚Ä¢ Ctrl+R - —Å–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
                </small>
            </div>
        </div>
    </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-canvas@3.0.1/build/cytoscape-canvas.cjs.js"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –æ —ç—Ç–∞–ø–∞—Ö
const stagesDataJson = '{{ stages_json|escapejs }}';
const stagesData = stagesDataJson ? JSON.parse(stagesDataJson) : [];

// –î–∞–Ω–Ω—ã–µ –æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö
const positionsDataJson = '{{ positions_json|escapejs }}';
const positionsData = positionsDataJson ? JSON.parse(positionsDataJson) : [];

document.addEventListener('DOMContentLoaded', function() {
    const templateId = parseInt('{{ template.id }}');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π
    let editMode = false;
    let isDrawing = false;
    let sourceNode = null;
    let tempEdge = null;
    let pendingConnections = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Å–≤—è–∑–µ–π
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Cytoscape
    const elements = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–∞—Ä—Ç"
    elements.push({
        data: { id: 'start', label: 'üü¢ –°—Ç–∞—Ä—Ç' },
        classes: 'start'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã —ç—Ç–∞–ø–æ–≤
    stagesData.forEach(stage => {
        const stageName = stage.sequence_number + '. ' + stage.name;
        const position = stage.position || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç X –¥–æ Y –µ–¥–∏–Ω–∏—Ü–∞"
        let durationText = '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        if (stage.duration_from && stage.duration_to) {
            if (stage.duration_from === stage.duration_to) {
                durationText = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + stage.duration_from + ' ' + (stage.duration_unit || '');
            } else {
                durationText = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + stage.duration_from + '-' + stage.duration_to + ' ' + (stage.duration_unit || '');
            }
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Ç–∫—É —Å –≤—Ä–µ–º–µ–Ω–µ–º
        const label = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' + stageName + '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' + position + '\n' + durationText;
        
        elements.push({
            data: {
                id: 'stage_' + stage.id,
                label: label,
                stageName: stageName,
                position: position,
                duration: durationText
            }
        });
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –¥–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ —Ä—è–¥–æ–º
        if (stage.materials && stage.materials.length > 0) {
            const materialsLabel = stage.materials.map(m => m.quantity + ' ' + m.unit + ' ' + m.name).join('\n');
            elements.push({
                data: {
                    id: 'materials_' + stage.id,
                    label: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:\n' + materialsLabel
                },
                classes: 'materials'
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –∏ —ç—Ç–∞–ø–æ–º (–ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –∫ —ç—Ç–∞–ø—É)
            elements.push({
                data: {
                    id: 'edge_stage_materials_' + stage.id,
                    source: 'materials_' + stage.id,
                    target: 'stage_' + stage.id
                },
                classes: 'materials-edge'
            });
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–æ–ø"
    elements.push({
        data: { id: 'stop', label: 'üî¥ –°—Ç–æ–ø' },
        classes: 'stop'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Å–≤—è–∑–∏)
    // –û—Ç –°—Ç–∞—Ä—Ç–∞ –∫ –ø–µ—Ä–≤–æ–º—É —ç—Ç–∞–ø—É
    if (stagesData.length > 0) {
        elements.push({
            data: {
                id: 'edge_start_' + stagesData[0].id,
                source: 'start',
                target: 'stage_' + stagesData[0].id
            }
        });
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —ç—Ç–∞–ø–æ–≤, —Å–æ–µ–¥–∏–Ω—è–µ–º –°—Ç–∞—Ä—Ç —Å–æ –°—Ç–æ–ø–æ–º
        elements.push({
            data: {
                id: 'edge_start_stop',
                source: 'start',
                target: 'stop'
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ –¥–ª—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
    stagesData.forEach(stage => {
        if (stage.parent_stage_id) {
            elements.push({
                data: {
                    id: 'edge_' + stage.parent_stage_id + '_' + stage.id,
                    source: 'stage_' + stage.parent_stage_id,
                    target: 'stage_' + stage.id
                }
            });
        }
    });
    
    // –û—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ –∫ –°—Ç–æ–ø—É
    if (stagesData.length > 0) {
        const lastStage = stagesData[stagesData.length - 1];
        elements.push({
            data: {
                id: 'edge_' + lastStage.id + '_stop',
                source: 'stage_' + lastStage.id,
                target: 'stop'
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏ –∫ Stop –¥–ª—è —ç—Ç–∞–ø–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ–¥—É—Ç –∫ Stop
    stagesData.forEach(stage => {
        if (stage.leads_to_stop) {
            const edgeId = 'edge_' + stage.id + '_stop';
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–æ–π edge –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
            if (!elements.find(el => el.data && el.data.id === edgeId)) {
                elements.push({
                    data: {
                        id: edgeId,
                        source: 'stage_' + stage.id,
                        target: 'stop'
                    }
                });
            }
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Cytoscape
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node:not(:parent)',
                style: {
                    'background-color': '#2d5016',
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': 24,
                    'font-weight': 'bold',
                    'color': 'white',
                    'border-width': 2,
                    'border-color': '#1a3009',
                    'padding': '20px',
                    'text-wrap': 'wrap',
                    'text-max-width': '260px',
                    'shape': 'rectangle',
                    'width': '336px',
                    'height': '220px',
                    'line-height': 1.2
                }
            },
            {
                selector: 'node:active',
                style: {
                    'border-width': 3,
                    'border-color': '#ff9800'
                }
            },
            {
                selector: 'node.start',
                style: {
                    'background-color': '#28a745',
                    'border-color': '#1e7e34',
                    'shape': 'ellipse',
                    'width': 120,
                    'height': 120,
                    'font-size': 20,
                    'font-weight': 'bold'
                }
            },
            {
                selector: 'node.stop',
                style: {
                    'background-color': '#155724',
                    'border-color': '#0d3818',
                    'shape': 'ellipse',
                    'width': 120,
                    'height': 120,
                    'font-size': 20,
                    'font-weight': 'bold'
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'background-color': '#3d7024',
                    'color': 'white',
                    'border-color': '#ff9800',
                    'border-width': 3
                }
            },
            {
                selector: 'edge',
                style: {
                    'line-color': '#0056b3',
                    'target-arrow-color': '#0056b3',
                    'target-arrow-shape': 'triangle',
                    'arrow-scale': 2,
                    'width': 3,
                    'curve-style': 'bezier',
                    'opacity': 0.8
                }
            },
            {
                selector: 'edge:active',
                style: {
                    'line-color': '#ff9800',
                    'target-arrow-color': '#ff9800',
                    'width': 4,
                    'opacity': 1
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#ff9800',
                    'target-arrow-color': '#ff9800',
                    'width': 4,
                    'opacity': 1
                }
            },
            {
                selector: 'node.materials',
                style: {
                    'background-color': '#f0f0f0',
                    'border-color': '#666',
                    'border-width': 3,
                    'color': '#333',
                    'font-size': 12,
                    'font-weight': 'normal',
                    'padding': '15px',
                    'text-max-width': '200px',
                    'width': '220px',
                    'height': 'auto',
                    'min-height': '120px',
                    'text-wrap': 'wrap',
                    'line-height': 1.3
                }
            },
            {
                selector: 'edge.materials-edge',
                style: {
                    'line-color': '#999',
                    'target-arrow-color': '#999',
                    'target-arrow-shape': 'triangle',
                    'line-style': 'dashed',
                    'width': 2,
                    'opacity': 0.7,
                    'arrow-scale': 1.5
                }
            }
        ],
        layout: {
            name: 'breadthfirst',
            directed: true,
            animate: true,
            animationDuration: 500,
            spacingFactor: 1.5,
            roots: '#start'
        },
        wheelSensitivity: 0.1,
        minZoom: 0.1,
        maxZoom: 3
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –±–ª–æ–∫–æ–≤
    const savedPositions = localStorage.getItem('diagramPositions_' + templateId);
    if (savedPositions) {
        try {
            const positions = JSON.parse(savedPositions);
            cy.nodes().forEach(node => {
                if (positions[node.id()]) {
                    node.position(positions[node.id()]);
                }
            });
            console.log('Positions restored from localStorage');
        } catch (e) {
            console.error('Error loading saved positions:', e);
        }
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π, –∑–∞–ø—É—Å–∫–∞–µ–º layout
        cy.layout({ name: 'breadthfirst', directed: true, animate: true, animationDuration: 500, spacingFactor: 1.5, roots: '#start' }).run();
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —É–∑–ª–æ–≤
    cy.on('free', 'node', function(evt) {
        const positions = {};
        cy.nodes().forEach(node => {
            positions[node.id()] = node.position();
        });
        localStorage.setItem('diagramPositions_' + templateId, JSON.stringify(positions));
        console.log('Positions saved');
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —É–∑–µ–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
    cy.on('tap', function(evt) {
        const target = evt.target;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —É–∑–µ–ª
        if (!target || !target.isNode || !target.isNode()) {
            return;
        }
        
        const node = target;
        const nodeId = node.id();
        
        console.log('Tap on node:', nodeId, 'editMode:', editMode, 'isDrawing:', isDrawing, 'shiftKey:', evt.originalEvent.shiftKey);
        
        // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π –∞–∫—Ç–∏–≤–µ–Ω
        if (editMode) {
            // –ï—Å–ª–∏ —É–∂–µ —Ä–∏—Å—É–µ–º —Å–≤—è–∑—å, –∑–∞–≤–µ—Ä—à–∞–µ–º –µ—ë –Ω–∞ –ª—é–±–æ–º —É–∑–ª–µ (–∫—Ä–æ–º–µ Start)
            if (isDrawing) {
                const targetNode = node;
                const sourceId = sourceNode.id();
                const targetId = targetNode.id();
                
                console.log('Completing connection from', sourceId, 'to', targetId);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å–≤—è–∑—å
                if (sourceId === targetId) {
                    showStatus('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è', 'error');
                    cancelDrawing();
                    return;
                }
                
                // –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –∫ –°—Ç–∞—Ä—Ç—É
                if (targetId === 'start') {
                    showStatus('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –∫ –°—Ç–∞—Ä—Ç—É', 'error');
                    cancelDrawing();
                    return;
                }
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏ —Ü–µ–ª–µ–≤–æ–≥–æ —ç—Ç–∞–ø–æ–≤
                const sourceStageId = sourceId === 'start' ? 'start' : sourceId.replace('stage_', '');
                const targetStageId = targetId === 'stop' ? 'stop' : targetId.replace('stage_', '');
                
                // –°–æ–∑–¥–∞—ë–º ID –¥–ª—è –Ω–æ–≤–æ–π —Å–≤—è–∑–∏
                const newEdgeId = 'edge_' + sourceStageId + '_' + targetStageId;
                const existingEdge = cy.$('#' + newEdgeId);
                
                // –ï—Å–ª–∏ —Ç–∞–∫–æ–π —Å–≤—è–∑–∏ –µ—â—ë –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
                if (existingEdge.length === 0) {
                    cy.add({
                        data: {
                            id: newEdgeId,
                            source: sourceId,
                            target: targetId
                        }
                    });
                    
                    console.log('Edge added:', newEdgeId);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –æ–∂–∏–¥–∞—é—â–∏—Ö —Å–≤—è–∑–µ–π
                    pendingConnections.push({
                        sourceId: sourceId,
                        sourceStageId: sourceStageId,
                        targetId: targetId,
                        targetStageId: targetStageId,
                        edgeId: newEdgeId
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    document.getElementById('saveConnectionToStop').style.display = 'block';
                    
                    showStatus('–°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞ (' + pendingConnections.length + '). –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤—è–∑—å" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
                } else {
                    showStatus('–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
                }
                
                cancelDrawing();
                return;
            }
            
            // –ï—Å–ª–∏ –Ω–µ —Ä–∏—Å—É–µ–º —Å–≤—è–∑—å –∏ –Ω–∞–∂–∞—Ç Shift, –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å
            if (evt.originalEvent.shiftKey) {
                if (nodeId === 'start' || nodeId === 'stop') {
                    showStatus('–ù–µ–ª—å–∑—è —Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —É–∑–ª–æ–≤', 'error');
                    return;
                }
                
                // –ù–∞—á–∏–Ω–∞–µ–º —Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤—è–∑—å
                sourceNode = node;
                isDrawing = true;
                node.style('border-width', 4);
                node.style('border-color', '#0056b3');
                node.style('background-color', '#0056b3');
                showStatus('–°–≤—è–∑—å –Ω–∞—á–∞—Ç–∞. –ö–ª–∏–∫ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –±–ª–æ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', 'info');
                return;
            }
        }
        
        // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –≤—ã–±–æ—Ä –±–ª–æ–∫–∞
        if (nodeId === 'start' || nodeId === 'stop') {
            return;
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —ç—Ç–∞–ø–∞
        const stageId = nodeId.replace('stage_', '');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º—É
        document.getElementById('stageSelect').value = stageId;
        
        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å
        const stage = stagesData.find(s => s.id == stageId);
        if (stage) {
            if (stage.parent_stage_id) {
                document.getElementById('parentSelect').value = stage.parent_stage_id;
            } else {
                document.getElementById('parentSelect').value = '';
            }
            
            if (stage.position_id) {
                document.getElementById('positionSelect').value = stage.position_id;
            } else {
                document.getElementById('positionSelect').value = '';
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('durationMin').value = stage.duration_from || 1;
            document.getElementById('durationMax').value = stage.duration_to || 1;
        }
        
        showStatus('–≠—Ç–∞–ø –≤—ã–±—Ä–∞–Ω. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"', 'info');
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    function cancelDrawing() {
        if (sourceNode) {
            sourceNode.style('border-width', 2);
            sourceNode.style('border-color', '#1a3009');
            sourceNode.style('background-color', '#2d5016');
        }
        isDrawing = false;
        sourceNode = null;
        if (tempEdge) {
            cy.remove(tempEdge);
            tempEdge = null;
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (isDrawing) {
                cancelDrawing();
                showStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
            }
        }
        
        // Ctrl+R - —Å–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            cy.fit();
            showStatus('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω', 'info');
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('editModeToggle').addEventListener('change', function(e) {
        editMode = e.target.checked;
        document.getElementById('editModeInfo').style.display = editMode ? 'block' : 'none';
        
        if (editMode) {
            showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. Shift+–ö–ª–∏–∫ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π', 'info');
        } else {
            cancelDrawing();
            showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–µ–π (Delete)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Delete') {
            const selected = cy.$(':selected');
            if (selected.length > 0) {
                const element = selected[0];
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–±—Ä–æ (—Å—Ç—Ä–µ–ª–∫–∞)
                if (element.isEdge()) {
                    const sourceId = element.source().id();
                    const targetId = element.target().id();
                    
                    // –ù–µ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑—å Start -> –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø
                    if (sourceId === 'start' && !targetId.includes('stop')) {
                        showStatus('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Å–≤—è–∑—å', 'error');
                        return;
                    }
                    
                    // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑—å —Å –¥–∏–∞–≥—Ä–∞–º–º—ã
                    cy.remove(element);
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ —Å–≤—è–∑—å –∫ Stop, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ leads_to_stop
                    if (targetId === 'stop') {
                        const sourceStageId = sourceId.replace('stage_', '');
                        document.getElementById('stageSelect').value = sourceStageId;
                        document.getElementById('parentSelect').value = '';
                        
                        // –°–æ–∑–¥–∞—ë–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è leads_to_stop = false
                        const form = document.querySelector('form');
                        let leadsToStopInput = form.querySelector('input[name="leads_to_stop"]');
                        if (!leadsToStopInput) {
                            leadsToStopInput = document.createElement('input');
                            leadsToStopInput.type = 'hidden';
                            leadsToStopInput.name = 'leads_to_stop';
                            form.appendChild(leadsToStopInput);
                        }
                        leadsToStopInput.value = 'false';
                        
                        showStatus('–°–≤—è–∑—å –∫ –°—Ç–æ–ø —É–¥–∞–ª–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
                    } else {
                        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω–∞—è —Å–≤—è–∑—å –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏
                        const stageId = targetId.replace('stage_', '');
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è
                        document.getElementById('stageSelect').value = stageId;
                        document.getElementById('parentSelect').value = '';
                        
                        showStatus('–°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞ —Å –¥–∏–∞–≥—Ä–∞–º–º—ã. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
                    }
                }
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const form = document.querySelector('form');
    if (form) {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        document.getElementById('submitStageForm').addEventListener('click', function(e) {
            e.preventDefault();
            
            const stageId = document.getElementById('stageSelect').value;
            const parentId = document.getElementById('parentSelect').value;
            const positionId = document.getElementById('positionSelect').value;
            const durationMin = document.getElementById('durationMin').value;
            const durationMax = document.getElementById('durationMax').value;
            
            if (!stageId) {
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø', 'error');
                return;
            }
            
            const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è —ç—Ç–∞–ø–∞ –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (durationMin || durationMax) {
                const durationFormData = new FormData();
                if (durationMin) durationFormData.append('duration_min', durationMin);
                if (durationMax) durationFormData.append('duration_max', durationMax);
                durationFormData.append('csrfmiddlewaretoken', csrfToken);
                
                const durationUrl = '/superuser/templates/' + templateId + '/update-duration/' + stageId + '/';
                
                fetch(durationUrl, {
                    method: 'POST',
                    body: durationFormData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .catch(error => console.error('Duration update error:', error));
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ endpoint
            const formData = new FormData();
            formData.append('stage_id', stageId);
            formData.append('parent_stage_id', parentId || '');
            formData.append('position_id', positionId || '');
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            const apiUrl = '/superuser/templates/' + templateId + '/save-stage/';
            
            showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info');
            
            fetch(apiUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response URL:', response.url);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error('HTTP ' + response.status + ': ' + text.substring(0, 100));
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –≤–∏–∑—É–∞–ª—å–Ω–æ
                    const targetNodeId = 'stage_' + stageId;
                    const sourceNodeId = parentId ? 'stage_' + parentId : 'start';
                    
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Ä–µ–±—Ä–∞ –∫ —ç—Ç–æ–º—É —É–∑–ª—É (–∫—Ä–æ–º–µ —Å–≤—è–∑–µ–π –∫ Stop)
                    const incomingEdges = cy.edges().filter(edge => {
                        return edge.target().id() === targetNodeId && edge.source().id() !== 'stop';
                    });
                    cy.remove(incomingEdges);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å–≤—è–∑—å
                    const edgeId = 'edge_' + (parentId || 'start') + '_' + stageId;
                    const existingEdge = cy.$('#' + edgeId);
                    
                    if (existingEdge.length === 0) {
                        cy.add({
                            data: {
                                id: edgeId,
                                source: sourceNodeId,
                                target: targetNodeId
                            }
                        });
                    }
                    
                    showStatus('–≠—Ç–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showStatus('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + error.message, 'error');
            });
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —ç—Ç–∞–ø–∞ - –≤–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const stageSelectElement = document.getElementById('stageSelect');
    console.log('stageSelect element:', stageSelectElement);
    
    if (stageSelectElement) {
        stageSelectElement.addEventListener('change', function() {
            console.log('Change event fired!');
            const deleteBtn = document.getElementById('deleteStageBtn');
            deleteBtn.disabled = !this.value;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç—Ç–∞–ø–∞
            if (this.value) {
                const stage = stagesData.find(s => s.id == this.value);
                console.log('Selected stage:', stage);
                if (stage) {
                    console.log('Duration from:', stage.duration_from, 'Duration to:', stage.duration_to);
                    document.getElementById('durationMin').value = stage.duration_from || 1;
                    document.getElementById('durationMax').value = stage.duration_to || 1;
                    console.log('Fields updated:', document.getElementById('durationMin').value, document.getElementById('durationMax').value);
                }
            }
        });
    } else {
        console.error('stageSelect element not found!');
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
    document.getElementById('addStageBtn').addEventListener('click', function() {
        const stageName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç—Ç–∞–ø–∞:');
        if (!stageName || !stageName.trim()) {
            showStatus('–ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
            return;
        }
        
        const form = document.querySelector('form');
        const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
        
        const formData = new FormData();
        formData.append('stage_name', stageName.trim());
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        const apiUrl = '/superuser/templates/' + templateId + '/add-stage/';
        
        showStatus('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞...', 'info');
        
        fetch(apiUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('HTTP ' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showStatus('–≠—Ç–∞–ø —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showStatus('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + error.message, 'error');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞
    document.getElementById('deleteStageBtn').addEventListener('click', function() {
        const stageId = document.getElementById('stageSelect').value;
        if (!stageId) {
            showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            return;
        }
        
        const stageName = document.getElementById('stageSelect').options[document.getElementById('stageSelect').selectedIndex].text;
        
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–∞–ø "' + stageName + '"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            return;
        }
        
        const form = document.querySelector('form');
        const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
        
        const apiUrl = '/superuser/templates/' + templateId + '/delete-stage/' + stageId + '/';
        
        showStatus('–£–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞...', 'info');
        
        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error('HTTP ' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showStatus('–≠—Ç–∞–ø —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showStatus('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message, 'error');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤—è–∑–µ–π
    const confirmButton = document.getElementById('confirmSaveConnection');
    console.log('DEBUG: confirmSaveConnection button found:', confirmButton);
    
    if (confirmButton) {
        confirmButton.addEventListener('click', function(e) {
            console.log('DEBUG: confirmSaveConnection clicked!');
            e.preventDefault();
            
            if (pendingConnections.length === 0) {
                showStatus('–ù–µ—Ç —Å–≤—è–∑–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            const form = document.querySelector('form');
            const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
            
            showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ' + pendingConnections.length + ' —Å–≤—è–∑–µ–π...', 'info');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é —Å–≤—è–∑—å
            let savedCount = 0;
            let errorCount = 0;
            
            pendingConnections.forEach((conn, index) => {
                console.log('DEBUG: Saving connection', index + 1, ':', conn);
                
                const formData = new FormData();
                formData.append('source_stage_id', conn.sourceStageId === 'start' ? 'start' : conn.sourceStageId);
                formData.append('target_stage_id', conn.targetStageId === 'stop' ? 'stop' : conn.targetStageId);
                formData.append('csrfmiddlewaretoken', csrfToken);
                
                const apiUrl = '/superuser/templates/' + templateId + '/save-connection/';
                
                fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    console.log('DEBUG: Response data:', data);
                    
                    if (data.success) {
                        savedCount++;
                    } else {
                        errorCount++;
                        console.error('ERROR: Failed to save connection:', data.error);
                    }
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–≤—è–∑—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    if (savedCount + errorCount === pendingConnections.length) {
                        if (errorCount === 0) {
                            showStatus('–í—Å–µ ' + savedCount + ' —Å–≤—è–∑–µ–π —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ' + savedCount + ', –æ—à–∏–±–æ–∫: ' + errorCount, 'warning');
                        }
                    }
                })
                .catch(error => {
                    errorCount++;
                    console.error('DEBUG: Fetch error:', error);
                });
            });
            
            pendingConnections = [];
            document.getElementById('saveConnectionToStop').style.display = 'none';
        });
    } else {
        console.error('ERROR: confirmSaveConnection button not found!');
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤—è–∑–µ–π
    document.getElementById('cancelSaveConnection').addEventListener('click', function() {
        if (pendingConnections.length > 0) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∏ —Å –¥–∏–∞–≥—Ä–∞–º–º—ã
            pendingConnections.forEach(conn => {
                cy.remove('#' + conn.edgeId);
            });
            showStatus(pendingConnections.length + ' —Å–≤—è–∑–µ–π –æ—Ç–º–µ–Ω–µ–Ω—ã', 'info');
        }
        
        pendingConnections = [];
        document.getElementById('saveConnectionToStop').style.display = 'none';
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—á–∞—Ç–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
    document.getElementById('printDiagramBtn').addEventListener('click', function() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π zoom –∏ pan
        const currentZoom = cy.zoom();
        const currentPan = cy.pan();
        
        // –ü–æ–ª—É—á–∞–µ–º bounding box –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const bb = cy.elements().boundingBox();
        
        // A4 —Ä–∞–∑–º–µ—Ä—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö —Å —É—á–µ—Ç–æ–º –ø–æ–ª–µ–π (20mm = ~75px —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
        // A4: 210mm x 297mm = 794px x 1123px
        // –° –ø–æ–ª—è–º–∏: 644px x 973px
        const pageWidth = 644;
        const pageHeight = 973;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –ø–æ–¥–≥–æ–Ω–∫–∏ –≤—Å–µ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const diagramWidth = bb.w + 60; // +60 –¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤
        const diagramHeight = bb.h + 60;
        
        const scaleX = pageWidth / diagramWidth;
        const scaleY = pageHeight / diagramHeight;
        const scale = Math.min(scaleX, scaleY); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–∏–π –º–∞—Å—à—Ç–∞–±, —á—Ç–æ–±—ã –≤—Å—ë –≤–ª–µ–∑–ª–æ
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã
        const centerX = (pageWidth - diagramWidth * scale) / 2;
        const centerY = (pageHeight - diagramHeight * scale) / 2;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
        cy.animate({
            zoom: scale,
            pan: {
                x: centerX - bb.x1 * scale,
                y: centerY - bb.y1 * scale
            }
        }, {
            duration: 300
        });
        
        // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—á–∞—Ç–∞–µ–º
        setTimeout(() => {
            window.print();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π zoom –∏ pan
            setTimeout(() => {
                cy.animate({
                    zoom: currentZoom,
                    pan: currentPan
                }, {
                    duration: 300
                });
            }, 500);
        }, 400);
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        const alertClass = type === 'success' ? 'success' : (type === 'error' ? 'danger' : 'info');
        statusDiv.innerHTML = `<div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            const alert = statusDiv.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
