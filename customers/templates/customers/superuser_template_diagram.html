{% extends "customers/superuser_base.html" %}
{% load static %}

{% block title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤ - {{ template.name }}{% endblock %}
{% block header_title %}–î–∏–∞–≥—Ä–∞–º–º–∞ —ç—Ç–∞–ø–æ–≤: {{ template.name }}{% endblock %}

{% block action_buttons %}
<a href="{% url 'superuser_templates' %}" class="btn btn-sm btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card card-table">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞–ø–æ–≤ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)</h5>
                    <small class="text-muted">üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –±–ª–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏</small>
                </div>
            </div>
            <div class="card-body">
                {% csrf_token %}
                
                <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ Mermaid -->
                <div class="mermaid" id="mermaidDiagram">
                    graph TD
                    Start["üü¢ –°—Ç–∞—Ä—Ç"]
                    Stop["üî¥ –°—Ç–æ–ø"]
                    
                    {% for stage in all_stages %}
                    Stage{{ stage.id }}["<b>{{ stage.sequence_number }}. {{ stage.name }}</b><br/>{{ stage.position.name|default:'–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}<br/>{{ stage.duration_from }}-{{ stage.duration_to }}{% if stage.duration_unit %} {{ stage.duration_unit.abbreviation }}{% endif %}"]
                    {% endfor %}
                    
                    Start --> {% if all_stages %}Stage{{ all_stages.0.id }}{% else %}Stop{% endif %}
                    
                    {% for stage in all_stages %}
                        {% if stage.parent_stage %}
                        Stage{{ stage.parent_stage.id }} --> Stage{{ stage.id }}
                        {% elif forloop.first %}
                        Start --> Stage{{ stage.id }}
                        {% endif %}
                    {% endfor %}
                    
                    {% for stage in all_stages %}
                        {% if not stage.parent_stage and forloop.last %}
                        Stage{{ stage.id }} --> Stop
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ–º -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ–º —ç—Ç–∞–ø–æ–≤</h6>
                    <form method="post" action="{% url 'superuser_template_edit' template.id %}" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-5">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø:</label>
                            <select name="stage_id" class="form-select" required id="stageSelect">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
                                {% for stage in all_stages %}
                                <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç—Ç–∞–ø:</label>
                            <select name="parent_stage_id" class="form-select" id="parentSelect">
                                <option value="">-- –ù–µ—Ç –ø–æ–¥—á–∏–Ω–µ–Ω–∏—è --</option>
                                {% for stage in all_stages %}
                                <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" name="action" value="set_parent" class="btn btn-primary w-100">
                                <i class="bi bi-link me-1"></i> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ -->
                <div id="statusMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<style>
.mermaid {
    display: flex;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.mermaid svg {
    max-width: 100%;
    height: auto;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–∑–ª–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º—ã */
.mermaid .nodeLabel {
    font-size: 12px;
    font-weight: 500;
}

.mermaid .node {
    stroke: #007bff;
    stroke-width: 2px;
    fill: #007bff;
}

.mermaid .node text {
    fill: white;
    font-size: 12px;
}

.mermaid .edgePath path {
    stroke: #0056b3;
    stroke-width: 2px;
}

.mermaid .arrowheadPath {
    fill: #0056b3;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
// –î–∞–Ω–Ω—ã–µ –æ —ç—Ç–∞–ø–∞—Ö
const stagesData = {{ stages_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Mermaid
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'default',
        securityLevel: 'loose',
        flowchart: {
            useMaxWidth: true,
            htmlLabels: true
        }
    });
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
    mermaid.contentLoaded();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã
    const stageSelect = document.getElementById('stageSelect');
    const parentSelect = document.getElementById('parentSelect');
    
    if (stageSelect) {
        stageSelect.addEventListener('change', function() {
            const stageId = this.value;
            if (stageId) {
                // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞
                const stage = stagesData.find(s => s.id == parseInt(stageId));
                if (stage && stage.parent_stage_id) {
                    parentSelect.value = stage.parent_stage_id;
                } else {
                    parentSelect.value = '';
                }
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const stageId = stageSelect.value;
            const parentId = parentSelect.value;
            
            if (!stageId) {
                e.preventDefault();
                showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                showStatus('‚úì –ü–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                setTimeout(() => location.reload(), 1500);
            }, 500);
        });
    }
});

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}
</script>
{% endblock %}
