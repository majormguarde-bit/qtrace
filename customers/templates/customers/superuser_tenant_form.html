{% extends 'customers/superuser_base.html' %}

{% block title %}Редактирование организации - Панель управления{% endblock %}
{% block header_title %}Редактирование параметров организации{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-pencil-square me-2 text-primary"></i>Параметры: {{ tenant.name }}
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label fw-medium">Название организации</label>
                        <input type="text" name="name" class="form-control" value="{{ tenant.name }}" required>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-medium">Тарифный план</label>
                            <select name="subscription_plan" id="plan-select" class="form-select">
                                <option value="" data-days="0">Без тарифа</option>
                                {% for plan in plans %}
                                <option value="{{ plan.id }}" data-days="{{ plan.work_days_limit }}" {% if tenant.subscription_plan_id == plan.id %}selected{% endif %}>
                                    {{ plan.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-medium">Количество месяцев</label>
                            <input type="number" name="subscription_months" id="months-input" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-medium">Дата окончания</label>
                            <input type="date" name="subscription_end_date" id="end-date-input" class="form-control" value="{{ tenant.subscription_end_date|date:'Y-m-d' }}">
                            <div class="form-text small" id="calculation-hint"></div>
                        </div>
                    </div>

                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const planSelect = document.getElementById('plan-select');
                        const monthsInput = document.getElementById('months-input');
                        const endDateInput = document.getElementById('end-date-input');
                        const hint = document.getElementById('calculation-hint');

                        function updateEndDate() {
                            const selectedOption = planSelect.options[planSelect.selectedIndex];
                            const daysPerMonth = parseInt(selectedOption.getAttribute('data-days')) || 0;
                            const months = parseInt(monthsInput.value) || 1;

                            if (daysPerMonth > 0) {
                                const totalDays = daysPerMonth * months;
                                const date = new Date();
                                date.setDate(date.getDate() + totalDays);
                                
                                // Локальное форматирование даты в YYYY-MM-DD
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const formattedDate = `${year}-${month}-${day}`;
                                
                                endDateInput.value = formattedDate;
                                hint.innerHTML = `<i class="bi bi-info-circle me-1"></i> Рассчитано: ${totalDays} дней`;
                                hint.className = 'form-text small text-primary animated fadeIn';
                            } else {
                                hint.innerText = '';
                            }
                        }

                        // Слушатели событий
                        planSelect.addEventListener('change', function() {
                            console.log('Plan changed');
                            updateEndDate();
                        });
                        
                        monthsInput.addEventListener('input', function() {
                            console.log('Months changed');
                            updateEndDate();
                        });

                        // Если тариф уже выбран, но даты нет - можно рассчитать сразу
                        if (planSelect.value && !endDateInput.value) {
                            updateEndDate();
                        }
                    });
                    </script>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Телефон</label>
                            <input type="text" name="phone" class="form-control" value="{{ tenant.phone|default:'' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Email организации</label>
                            <input type="email" name="email" class="form-control" value="{{ tenant.email|default:'' }}">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Telegram</label>
                            <input type="text" name="telegram" class="form-control" value="{{ tenant.telegram|default:'' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Контактное лицо</label>
                            <input type="text" name="contact_person" class="form-control" value="{{ tenant.contact_person|default:'' }}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="can_admin_delete_media" id="can_admin_delete_media" {% if tenant.can_admin_delete_media %}checked{% endif %}>
                            <label class="form-check-label fw-medium" for="can_admin_delete_media">
                                Администратор тенанта может удалять файлы из медиатеки
                            </label>
                            <div class="form-text">Если выключено, администратор тенанта не сможет удалять файлы, загруженные сотрудниками.</div>
                        </div>
                    </div>

                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">Статус активации</h6>
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    {% if tenant.is_active %}
                                        <span class="badge bg-success px-3 py-2">
                                            <i class="bi bi-check-circle me-1"></i> Активен
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger px-3 py-2">
                                            <i class="bi bi-x-circle me-1"></i> Ожидает активации / Заблокирован
                                        </span>
                                    {% endif %}
                                </div>
                                <a href="{% url 'superuser_tenant_toggle_status' tenant.id %}" class="btn {% if tenant.is_active %}btn-outline-danger{% else %}btn-success{% endif %} btn-sm">
                                    {% if tenant.is_active %}
                                        <i class="bi bi-lock me-1"></i> Заблокировать
                                    {% else %}
                                        <i class="bi bi-unlock me-1"></i> Активировать
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 bg-white shadow-sm mb-4">
                        <div class="card-header bg-transparent border-bottom-0 pt-4 px-0">
                            <div class="d-flex justify-content-between align-items-center px-4">
                                <h6 class="fw-bold mb-0">Последние платежи</h6>
                                <span class="fw-bold text-primary">{{ total_paid }} ₽</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">Дата</th>
                                            <th>Сумма</th>
                                            <th class="pe-4">Описание</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in payments %}
                                        <tr>
                                            <td class="ps-4">{{ payment.date|date:"d.m.Y" }}</td>
                                            <td class="fw-bold">{{ payment.amount }} ₽</td>
                                            <td class="pe-4 small text-muted">{{ payment.description|default:"—" }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center py-3 text-muted">Нет платежей</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0 pb-4 text-center">
                            <a href="{% url 'superuser_client_payments' tenant.id %}" class="btn btn-link btn-sm text-decoration-none">
                                Все платежи <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-5">
                        <a href="{% url 'superuser_tenants' %}" class="btn btn-outline-secondary px-4">
                            <i class="bi bi-arrow-left me-2"></i>Отмена
                        </a>
                        <button type="submit" class="btn btn-primary px-5">
                            Сохранить изменения
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
