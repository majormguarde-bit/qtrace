# Журнал администратора

## Обзор

Раздел "Журнал" в администрировании предоставляет полный контроль над всеми операциями с паролями, включая пагинацию, поиск и фильтры.

## Доступ

**Путь:** Администрирование → Журнал

**Требования:** Администратор или сотрудник с правами staff

## Функциональность

### 1. Таблица логов

Отображает все записи о генерации паролей с информацией:
- **Время** - Дата и время операции (UTC)
- **Администратор** - Кто выполнил операцию
- **Сотрудник** - Логин сотрудника, для которого был сгенерирован пароль
- **Действие** - Тип операции (Сгенерирован, Сброшен, Просмотрен)
- **Длина пароля** - Количество символов в пароле
- **IP адрес** - IP адрес администратора
- **Примечания** - Дополнительная информация

### 2. Поиск

**Поле:** "Поиск по логину"

Позволяет быстро найти все операции для конкретного сотрудника:
```
Введите: wb-worker-1
Результат: Все операции для этого сотрудника
```

### 3. Фильтры

#### Администратор
Фильтр по администратору, выполнившему операцию:
- Все администраторы (по умолчанию)
- Список всех администраторов системы

#### Действие
Фильтр по типу операции:
- Все действия (по умолчанию)
- Сгенерирован - Пароль был сгенерирован
- Сброшен - Пароль был сброшен
- Просмотрен - Пароль был просмотрен

#### Дата (от)
Фильтр по начальной дате:
- Выберите дату в формате YYYY-MM-DD
- Будут показаны записи с этой даты и позже

#### Дата (до)
Фильтр по конечной дате:
- Выберите дату в формате YYYY-MM-DD
- Будут показаны записи до этой даты включительно

### 4. Пагинация

**Записей на странице:** 25

**Навигация:**
- ◀◀ - Первая страница
- ◀ - Предыдущая страница
- Номера страниц (1, 2, 3...)
- ▶ - Следующая страница
- ▶▶ - Последняя страница

**Информация:**
- Текущая страница и общее количество страниц
- Количество показанных записей и общее количество

## Примеры использования

### Пример 1: Найти все операции для сотрудника

1. Введите логин в поле "Поиск по логину": `wb-worker-1`
2. Нажмите "Применить фильтры"
3. Будут показаны все операции для этого сотрудника

### Пример 2: Найти операции администратора за период

1. Выберите администратора в фильтре "Администратор"
2. Установите дату "От даты": `2026-01-01`
3. Установите дату "До даты": `2026-01-31`
4. Нажмите "Применить фильтры"
5. Будут показаны все операции этого администратора за январь

### Пример 3: Найти все сгенерированные пароли

1. Выберите "Сгенерирован" в фильтре "Действие"
2. Нажмите "Применить фильтры"
3. Будут показаны только операции генерации паролей

### Пример 4: Комбинированный поиск

1. Введите логин: `john-doe`
2. Выберите администратора: `admin_username`
3. Выберите действие: `Сгенерирован`
4. Установите дату "От даты": `2026-01-15`
5. Нажмите "Применить фильтры"
6. Будут показаны все пароли, сгенерированные администратором для john-doe с 15 января

## Сброс фильтров

Нажмите кнопку "Сбросить" для очистки всех фильтров и возврата к полному списку логов.

## Структура данных

### Модель AdminPasswordLog

```python
class AdminPasswordLog(models.Model):
    admin_user = ForeignKey(User)           # Администратор
    employee_username = CharField()         # Логин сотрудника
    action = CharField()                    # Действие (generated, reset, viewed)
    password_length = IntegerField()        # Длина пароля
    timestamp = DateTimeField()             # Время операции
    ip_address = GenericIPAddressField()    # IP адрес администратора
    user_agent = TextField()                # User Agent браузера
    notes = TextField()                     # Примечания
```

## Информация в логе

Каждая запись содержит:

```json
{
  "timestamp": "2026-01-30T12:34:56.789Z",
  "admin_user": "admin_username",
  "employee_username": "wb-worker-1",
  "action": "generated",
  "password_length": 16,
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "notes": "Generated via API"
}
```

## Безопасность

- ✅ Только администраторы могут просматривать журнал
- ✅ Все операции логируются с IP адресом
- ✅ Временные метки в UTC
- ✅ Идентификация администратора
- ✅ Полная аудит-тропа

## Экспорт данных

### Экспорт через админ-панель

1. Откройте админ-панель Django
2. Перейдите в "Логи генерации паролей"
3. Используйте встроенные фильтры и поиск
4. Экспортируйте данные (если доступно)

### Экспорт через API

```bash
# Получить все логи
curl http://localhost:8000/admin/logs/

# Получить логи с фильтрами
curl "http://localhost:8000/admin/logs/?search=wb-worker-1&action=generated"
```

## Хранение данных

- **База данных:** PostgreSQL (или другая БД Django)
- **Ротация:** Не требуется (БД управляет хранением)
- **Резервная копия:** Включена в резервные копии БД
- **Удаление:** Логи хранятся неограниченно (можно настроить)

## Производительность

- **Индексы:** На полях timestamp, employee_username, admin_user
- **Пагинация:** 25 записей на странице
- **Поиск:** Быстрый поиск по индексированным полям
- **Фильтры:** Оптимизированные запросы к БД

## Администрирование

### Просмотр в админ-панели

1. Откройте админ-панель Django
2. Перейдите в "Логи генерации паролей"
3. Используйте встроенные фильтры и поиск

### Удаление старых логов

```python
from dashboard.models import AdminPasswordLog
from datetime import datetime, timedelta

# Удалить логи старше 90 дней
old_date = datetime.now() - timedelta(days=90)
AdminPasswordLog.objects.filter(timestamp__lt=old_date).delete()
```

### Статистика

```python
from dashboard.models import AdminPasswordLog
from django.db.models import Count

# Количество операций по администраторам
AdminPasswordLog.objects.values('admin_user__username').annotate(count=Count('id'))

# Количество операций по действиям
AdminPasswordLog.objects.values('action').annotate(count=Count('id'))

# Количество операций по дням
AdminPasswordLog.objects.extra(select={'day': 'DATE(timestamp)'}).values('day').annotate(count=Count('id'))
```

## Файлы

- `skkp_project/dashboard/models.py` - Модель AdminPasswordLog
- `skkp_project/dashboard/views.py` - Представление admin_log_list
- `skkp_project/dashboard/urls.py` - URL маршрут
- `skkp_project/dashboard/templates/dashboard/admin_log_list.html` - Шаблон
- `skkp_project/dashboard/admin.py` - Регистрация в админ-панели
- `skkp_project/dashboard/migrations/0001_initial.py` - Миграция БД

## Требования

- ✅ Django 5.2+
- ✅ Python 3.8+
- ✅ PostgreSQL или другая БД
- ✅ Права администратора

## Поддержка

Для вопросов или проблем обратитесь к администратору системы.

---

**Версия:** 1.0  
**Дата:** 30 января 2026  
**Статус:** ✅ Готово к использованию
