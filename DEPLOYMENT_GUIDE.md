# Инструкция по развертыванию изменений на хостинге

## Описание изменений

Этот коммит включает следующие улучшения UI:
- Компактное меню (уменьшены отступы между пунктами)
- Светлые и жирные заголовки разделов меню
- Темные иконки действий в таблицах (для лучшей видимости на белом фоне)
- По умолчанию открываются "Мои шаблоны" вместо "Типовых шаблонов"
- Удален столбец "Статус предложения" из списка шаблонов
- Зафиксирована типовая логика маршрутизации (лендинг для всех, авторизация в панелях)

## Предварительные требования

1. SSH доступ к серверу
2. Права на выполнение команд от имени пользователя приложения
3. Доступ к git репозиторию
4. Установленный Python и виртуальное окружение

## Шаг 1: Подключение к серверу

```bash
ssh username@your-server.com
```

## Шаг 2: Переход в директорию проекта

```bash
cd /path/to/your/project/skkp_project
```

Обычно путь выглядит так:
- `/home/username/skkp_project`
- `/var/www/skkp_project`
- `/opt/skkp_project`

## Шаг 3: Создание резервной копии (ВАЖНО!)

Перед применением изменений создайте резервную копию:

```bash
# Резервная копия базы данных
pg_dump -U postgres -d skkp_db > ~/backup_$(date +%Y%m%d_%H%M%S).sql

# Резервная копия файлов проекта
cd ..
tar -czf skkp_project_backup_$(date +%Y%m%d_%H%M%S).tar.gz skkp_project/
cd skkp_project
```

## Шаг 4: Получение изменений из git

### Вариант A: Если используете ветку feature/diagram-cytoscape

```bash
# Проверяем текущую ветку
git branch

# Получаем изменения
git fetch origin

# Переключаемся на нужную ветку (если не на ней)
git checkout feature/diagram-cytoscape

# Получаем последние изменения
git pull origin feature/diagram-cytoscape
```

### Вариант B: Если нужно слить в main/master

```bash
# Переключаемся на main
git checkout main

# Получаем изменения
git pull origin main

# Сливаем ветку feature/diagram-cytoscape
git merge feature/diagram-cytoscape

# Или используем rebase для чистой истории
# git rebase feature/diagram-cytoscape
```

## Шаг 5: Активация виртуального окружения

```bash
# Для Linux/Unix
source venv/bin/activate

# Или если используется другое имя окружения
source venv_new/bin/activate
```

## Шаг 6: Установка/обновление зависимостей

```bash
pip install -r requirements.txt
```

## Шаг 7: Применение миграций базы данных

```bash
python manage.py migrate
```

## Шаг 8: Сбор статических файлов

```bash
python manage.py collectstatic --noinput
```

## Шаг 9: Проверка изменений

Проверьте, что нет ошибок в коде:

```bash
python manage.py check
```

## Шаг 10: Перезапуск приложения

### Для Passenger (Phusion Passenger)

```bash
# Создаем/обновляем файл restart.txt
mkdir -p tmp
touch tmp/restart.txt
```

### Для Gunicorn с systemd

```bash
sudo systemctl restart skkp_project
# или
sudo systemctl restart gunicorn
```

### Для uWSGI

```bash
sudo systemctl restart uwsgi
# или
sudo service uwsgi restart
```

### Для Apache с mod_wsgi

```bash
sudo systemctl restart apache2
# или
sudo service apache2 restart
```

### Для Nginx + Gunicorn

```bash
sudo systemctl restart gunicorn
sudo systemctl reload nginx
```

## Шаг 11: Проверка работоспособности

1. Откройте сайт в браузере
2. Проверьте основные страницы:
   - Лендинг: `https://your-domain.com/`
   - Панель суперпользователя: `https://your-domain.com/superuser/`
   - Панель тенанта: `https://tenant.your-domain.com/`
   - Мои шаблоны: `https://tenant.your-domain.com/my-templates/`

3. Проверьте логи на наличие ошибок:

```bash
# Логи приложения
tail -f /path/to/logs/error.log

# Логи Passenger
tail -f /path/to/passenger.log

# Логи Gunicorn
sudo journalctl -u gunicorn -f

# Логи Nginx
sudo tail -f /var/log/nginx/error.log
```

## Шаг 12: Проверка изменений UI

Проверьте следующие изменения:

1. **Компактное меню**: Пункты меню должны быть ближе друг к другу
2. **Заголовки разделов**: Должны быть светлыми, жирными и увеличенными
3. **Иконки в таблицах**: Должны быть темными (кроме красной иконки удаления)
4. **Мои шаблоны**: По умолчанию должна открываться вкладка "Мои шаблоны"
5. **Лендинг**: Главная страница должна показывать лендинг всем пользователям

## Откат изменений (если что-то пошло не так)

### Откат git изменений

```bash
# Посмотреть последние коммиты
git log --oneline -10

# Откатиться на предыдущий коммит
git reset --hard HEAD~1

# Или откатиться на конкретный коммит
git reset --hard <commit-hash>

# Перезапустить приложение (см. Шаг 10)
```

### Восстановление базы данных

```bash
# Остановить приложение
sudo systemctl stop gunicorn  # или другой сервис

# Восстановить базу данных
psql -U postgres -d skkp_db < ~/backup_YYYYMMDD_HHMMSS.sql

# Запустить приложение
sudo systemctl start gunicorn
```

## Мониторинг после развертывания

Следите за следующими метриками в течение первых 24 часов:

1. **Логи ошибок**: Проверяйте на наличие новых ошибок
2. **Производительность**: Время загрузки страниц
3. **Обратная связь пользователей**: Жалобы на UI/UX

## Контрольный список

- [ ] Создана резервная копия БД
- [ ] Создана резервная копия файлов
- [ ] Получены изменения из git
- [ ] Активировано виртуальное окружение
- [ ] Установлены/обновлены зависимости
- [ ] Применены миграции
- [ ] Собраны статические файлы
- [ ] Выполнена проверка кода
- [ ] Перезапущено приложение
- [ ] Проверена работоспособность сайта
- [ ] Проверены изменения UI
- [ ] Проверены логи на ошибки

## Дополнительные команды

### Просмотр текущего коммита

```bash
git log -1 --oneline
```

### Просмотр изменений в файлах

```bash
git diff HEAD~1 HEAD
```

### Проверка статуса git

```bash
git status
```

### Очистка кэша Django

```bash
python manage.py shell
>>> from django.core.cache import cache
>>> cache.clear()
>>> exit()
```

## Контакты для поддержки

В случае проблем:
1. Проверьте логи приложения
2. Проверьте логи веб-сервера
3. Откатите изменения (см. раздел "Откат изменений")
4. Свяжитесь с разработчиком

## Примечания

- Все изменения касаются только UI и не затрагивают логику работы приложения
- Миграции БД не требуются (но команду migrate нужно выполнить для проверки)
- Изменения обратно совместимы
- Время простоя при развертывании: ~1-2 минуты (только перезапуск)

---

**Дата создания инструкции**: 30 января 2026  
**Версия**: 1.0  
**Коммит**: 6042d6e
