# Руководство по экспорту и импорту шаблонов

## Описание функционала

Система позволяет экспортировать и импортировать шаблоны задач в формате JSON. Это полезно для:
- Обмена шаблонами между тенантами
- Резервного копирования шаблонов
- Переноса шаблонов из локальных в типовые (и наоборот)
- Отправки шаблонов по email
- Хранения шаблонов в системе контроля версий

## Что экспортируется

При экспорте шаблона сохраняется:
- ✅ Название и описание шаблона
- ✅ Категория активности
- ✅ Все этапы с параметрами:
  - Название и описание этапа
  - Порядковый номер
  - Длительность (от/до) и единица измерения
  - Должность исполнителя
  - Связь с родительским этапом
  - Флаг "ведет к остановке"
- ✅ Материалы этапов:
  - Название материала
  - Количество
  - Единица измерения
- ✅ Диаграмма SVG (если есть)

## Формат файла

Файлы экспортируются в формате JSON с расширением `.json`. Пример структуры:

```json
{
  "version": "1.0",
  "template": {
    "name": "Сборка печатной платы",
    "description": "Полный цикл сборки печатной платы",
    "template_type": "local",
    "activity_category": "Производство",
    "diagram_svg": "...",
    "stages": [
      {
        "name": "Подготовка компонентов",
        "description": "Проверка и подготовка всех компонентов",
        "sequence_number": 1,
        "duration_from": 30.0,
        "duration_to": 45.0,
        "duration_unit": "минуты",
        "position": "Монтажник",
        "parent_stage_sequence": null,
        "leads_to_stop": false,
        "materials": [
          {
            "material_name": "Резисторы",
            "quantity": 10.0,
            "unit": "штуки"
          }
        ]
      }
    ]
  }
}
```

## Экспорт шаблонов

### Для администраторов тенантов

1. Перейдите на страницу "Мои шаблоны": `http://tenant.domain.com/my-templates/`
2. Найдите нужный шаблон в списке
3. Нажмите кнопку с иконкой загрузки (⬇️) в столбце "Действия"
4. Файл автоматически скачается с именем `template_название_шаблона.json`

### Для суперпользователей

1. Перейдите на страницу "Глобальные шаблоны": `http://domain.com/superuser/templates/`
2. Найдите нужный шаблон в списке
3. Нажмите кнопку "Экспорт" рядом с шаблоном
4. Файл автоматически скачается

## Импорт шаблонов

### Для администраторов тенантов

1. Перейдите на страницу "Мои шаблоны": `http://tenant.domain.com/my-templates/`
2. Нажмите кнопку "Импорт" в правом верхнем углу
3. В открывшемся окне:
   - Выберите JSON файл с шаблоном
   - Выберите тип шаблона:
     - **Мой шаблон** - импорт в локальные шаблоны тенанта
     - **Типовой шаблон** - импорт в глобальные шаблоны (только для суперпользователей)
   - Выберите стратегию при конфликте имен:
     - **Переименовать** - добавит "(копия)" к имени
     - **Пропустить** - не импортирует, если имя занято
     - **Перезаписать** - удалит существующий и создаст новый
4. Нажмите "Импортировать"
5. Система покажет результат импорта

### Для суперпользователей

1. Перейдите на страницу "Глобальные шаблоны": `http://domain.com/superuser/templates/`
2. Нажмите кнопку "Импорт" в правом верхнем углу
3. Выберите JSON файл и стратегию конфликтов
4. Нажмите "Импортировать"

## Стратегии разрешения конфликтов

### Переименовать (рекомендуется)
- Если шаблон с таким именем существует, к имени добавляется "(копия)"
- Если "(копия)" тоже занято, добавляется "(копия 2)", "(копия 3)" и т.д.
- Безопасный вариант, не теряет данные

### Пропустить
- Если шаблон с таким именем существует, импорт пропускается
- Полезно при массовом импорте, чтобы не дублировать существующие шаблоны

### Перезаписать
- Удаляет существующий шаблон и создает новый
- ⚠️ **ВНИМАНИЕ**: Старые данные будут потеряны безвозвратно!
- Используйте только если уверены

## Автоматическое создание справочников

При импорте система автоматически создает отсутствующие:
- Категории активностей
- Материалы
- Единицы измерения
- Должности

Если объект с таким именем уже существует, используется существующий.

## Примеры использования

### Обмен шаблонами между тенантами

1. Тенант A экспортирует свой шаблон
2. Отправляет JSON файл тенанту B по email
3. Тенант B импортирует файл в свои локальные шаблоны
4. Тенант B может редактировать импортированный шаблон

### Создание резервной копии

```bash
# Экспортируйте все важные шаблоны
# Сохраните JSON файлы в безопасное место
# При необходимости восстановите через импорт
```

### Перенос из локальных в типовые

1. Администратор тенанта экспортирует локальный шаблон
2. Отправляет файл суперпользователю
3. Суперпользователь импортирует в глобальные шаблоны
4. Теперь шаблон доступен всем тенантам

### Версионирование шаблонов

```bash
# Сохраните JSON файлы в git репозиторий
git add templates/*.json
git commit -m "Update template: Assembly process v2.0"
git push

# При необходимости откатитесь к предыдущей версии
git checkout HEAD~1 templates/assembly.json
# Импортируйте старую версию через UI
```

## Ограничения и особенности

### Права доступа

- **Экспорт локальных шаблонов**: только администраторы тенантов
- **Экспорт типовых шаблонов**: все пользователи
- **Импорт в локальные**: только администраторы тенантов
- **Импорт в типовые**: только суперпользователи

### Размер файлов

- Обычный шаблон: 5-50 KB
- Шаблон с большой диаграммой: до 500 KB
- Рекомендуется не превышать 1 MB на файл

### Совместимость

- Формат версии 1.0
- Обратная совместимость гарантируется
- При изменении формата версия будет увеличена

## Устранение проблем

### Ошибка "Неверный формат файла"

- Убедитесь, что файл имеет расширение `.json`
- Проверьте, что файл не поврежден
- Откройте файл в текстовом редакторе и проверьте структуру JSON

### Ошибка "Ошибка парсинга JSON"

- Файл содержит невалидный JSON
- Проверьте файл на сайте jsonlint.com
- Возможно, файл был поврежден при передаче

### Предупреждение "Шаблон переименован"

- Это нормально при стратегии "Переименовать"
- Шаблон успешно импортирован с новым именем
- Вы можете переименовать его вручную после импорта

### Предупреждение "Неизвестная версия формата"

- Файл создан в более новой версии системы
- Импорт может работать некорректно
- Обновите систему до последней версии

## API для разработчиков

### Программный экспорт

```python
from task_templates.export_import import TemplateExporter
from task_templates.models import TaskTemplate

# Экспорт одного шаблона
template = TaskTemplate.objects.get(id=1)
json_string = TemplateExporter.export_to_json(template)

# Экспорт нескольких шаблонов
templates = TaskTemplate.objects.filter(template_type='local')
json_string = TemplateExporter.export_multiple_templates(templates)

# Сохранение в файл
with open('template.json', 'w', encoding='utf-8') as f:
    f.write(json_string)
```

### Программный импорт

```python
from task_templates.export_import import TemplateImporter

# Чтение из файла
with open('template.json', 'r', encoding='utf-8') as f:
    json_string = f.read()

# Импорт
importer = TemplateImporter(user=request.user, tenant=request.tenant)
result = importer.import_from_json(
    json_string,
    template_type='local',
    conflict_strategy='rename'
)

# Проверка результата
if result['success']:
    print(f"Импортировано шаблонов: {len(result['created']['templates'])}")
    print(f"Создано категорий: {len(result['created']['categories'])}")
    print(f"Создано материалов: {len(result['created']['materials'])}")
else:
    print("Ошибки:", result['errors'])
```

## Часто задаваемые вопросы

**Q: Можно ли экспортировать несколько шаблонов одновременно?**  
A: В текущей версии экспортируется по одному шаблону. Для массового экспорта используйте API.

**Q: Сохраняются ли ID объектов при импорте?**  
A: Нет, при импорте создаются новые объекты с новыми ID.

**Q: Можно ли редактировать JSON файл вручную?**  
A: Да, но будьте осторожны с форматом. Рекомендуется использовать JSON редактор.

**Q: Что делать, если импорт завис?**  
A: Обновите страницу и попробуйте снова. Проверьте размер файла (не более 1 MB).

**Q: Можно ли импортировать шаблон из старой версии системы?**  
A: Да, если версия формата совпадает (1.0). При несовпадении будет предупреждение.

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь, что файл валидный JSON
3. Проверьте права доступа пользователя
4. Свяжитесь с администратором системы

---

**Версия документа**: 1.0  
**Дата создания**: 30 января 2026  
**Коммит**: 8f2cf97
