{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% else %}
<div class="template-detail">
    <h6 class="mb-3">{{ template.name }}</h6>
    
    {% if template.description %}
    <div class="mb-3">
        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
        <p class="text-muted">{{ template.description }}</p>
    </div>
    {% endif %}
    
    {% if template.activity_category %}
    <div class="mb-3">
        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong>
        <span class="badge bg-light text-dark border">{{ template.activity_category.name }}</span>
    </div>
    {% endif %}
    
    <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Å–ø–∏—Å–∫–æ–º –∏ –¥–∏–∞–≥—Ä–∞–º–º–æ–π -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="stages-tab" data-bs-toggle="tab" data-bs-target="#stages-content" type="button" role="tab">
                <i class="bi bi-list me-1"></i> –°–ø–∏—Å–æ–∫ —ç—Ç–∞–ø–æ–≤
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="diagram-tab" data-bs-toggle="tab" data-bs-target="#diagram-content" type="button" role="tab">
                <i class="bi bi-diagram-3 me-1"></i> –î–∏–∞–≥—Ä–∞–º–º–∞
            </button>
        </li>
    </ul>
    
    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content">
        <!-- –í–∫–ª–∞–¥–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —ç—Ç–∞–ø–æ–≤ -->
        <div class="tab-pane fade show active" id="stages-content" role="tabpanel">
            <div class="mb-3">
                <strong>–≠—Ç–∞–ø—ã ({{ stages.count }}):</strong>
                <div class="mt-2">
                    {% for stage in stages %}
                    <div class="card card-sm mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ stage.sequence_number }}. {{ stage.name }}</strong>
                                    {% if stage.position %}
                                    <br><small class="text-muted">–î–æ–ª–∂–Ω–æ—Å—Ç—å: {{ stage.position.name }}</small>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        {% if stage.duration_from == stage.duration_to %}
                                            {{ stage.duration_from }} {{ stage.duration_unit.name|default:"" }}
                                        {% else %}
                                            {{ stage.duration_from }}-{{ stage.duration_to }} {{ stage.duration_unit.name|default:"" }}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">–≠—Ç–∞–ø—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —Å –¥–∏–∞–≥—Ä–∞–º–º–æ–π -->
        <div class="tab-pane fade" id="diagram-content" role="tabpanel">
            <div id="templateDiagram" style="height: 400px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
document.getElementById('diagram-tab').addEventListener('shown.bs.tab', function() {
    initTemplateDiagram();
});

function initTemplateDiagram() {
    try {
        const stagesJsonStr = '{{ stages_json|escapejs }}';
        const stagesData = stagesJsonStr ? JSON.parse(stagesJsonStr) : [];
        const templateId = {{ template.id }};
        
        console.log('Stages data:', stagesData);
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Cytoscape
        const elements = [];
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–∞—Ä—Ç"
        elements.push({
            data: { id: 'start', label: 'üü¢ –°—Ç–∞—Ä—Ç' },
            classes: 'start'
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã —ç—Ç–∞–ø–æ–≤
        stagesData.forEach(stage => {
            const stageName = stage.sequence_number + '. ' + stage.name;
            const position = stage.position || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            let durationText = '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            if (stage.duration_from && stage.duration_to) {
                if (stage.duration_from === stage.duration_to) {
                    durationText = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + stage.duration_from + ' ' + (stage.duration_unit || '');
                } else {
                    durationText = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + stage.duration_from + '-' + stage.duration_to + ' ' + (stage.duration_unit || '');
                }
            }
            
            const label = stageName + '\n' + position + '\n' + durationText;
            
            elements.push({
                data: {
                    id: 'stage_' + stage.id,
                    label: label,
                    stageName: stageName,
                    position: position,
                    duration: durationText
                }
            });
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–æ–ø"
        elements.push({
            data: { id: 'stop', label: 'üî¥ –°—Ç–æ–ø' },
            classes: 'stop'
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Å–≤—è–∑–∏)
        // –û—Ç –°—Ç–∞—Ä—Ç–∞ –∫ –ø–µ—Ä–≤–æ–º—É —ç—Ç–∞–ø—É
        if (stagesData.length > 0) {
            elements.push({
                data: {
                    id: 'edge_start_' + stagesData[0].id,
                    source: 'start',
                    target: 'stage_' + stagesData[0].id
                }
            });
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç —ç—Ç–∞–ø–æ–≤, —Å–æ–µ–¥–∏–Ω—è–µ–º –°—Ç–∞—Ä—Ç —Å–æ –°—Ç–æ–ø–æ–º
            elements.push({
                data: {
                    id: 'edge_start_stop',
                    source: 'start',
                    target: 'stop'
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ –¥–ª—è –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ—Å—Ç–∏
        stagesData.forEach(stage => {
            if (stage.parent_stage_id) {
                elements.push({
                    data: {
                        id: 'edge_' + stage.parent_stage_id + '_' + stage.id,
                        source: 'stage_' + stage.parent_stage_id,
                        target: 'stage_' + stage.id
                    }
                });
            }
        });
        
        // –û—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ –∫ –°—Ç–æ–ø—É
        if (stagesData.length > 0) {
            const lastStage = stagesData[stagesData.length - 1];
            elements.push({
                data: {
                    id: 'edge_' + lastStage.id + '_stop',
                    source: 'stage_' + lastStage.id,
                    target: 'stop'
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏ –∫ Stop –¥–ª—è —ç—Ç–∞–ø–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ–¥—É—Ç –∫ Stop
        stagesData.forEach(stage => {
            if (stage.leads_to_stop) {
                const edgeId = 'edge_' + stage.id + '_stop';
                if (!elements.find(el => el.data && el.data.id === edgeId)) {
                    elements.push({
                        data: {
                            id: edgeId,
                            source: 'stage_' + stage.id,
                            target: 'stop'
                        }
                    });
                }
            }
        });
        
        console.log('Elements:', elements);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Cytoscape
        const cy = cytoscape({
            container: document.getElementById('templateDiagram'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#2d5016',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': 12,
                        'font-weight': 'bold',
                        'color': 'white',
                        'border-width': 2,
                        'border-color': '#1a3009',
                        'padding': '10px',
                        'text-wrap': 'wrap',
                        'text-max-width': '150px',
                        'shape': 'rectangle',
                        'width': '180px',
                        'height': '120px',
                        'line-height': 1.2
                    }
                },
                {
                    selector: 'node.start',
                    style: {
                        'background-color': '#28a745',
                        'border-color': '#1e7e34',
                        'shape': 'ellipse',
                        'width': 80,
                        'height': 80,
                        'font-size': 14,
                        'font-weight': 'bold'
                    }
                },
                {
                    selector: 'node.stop',
                    style: {
                        'background-color': '#155724',
                        'border-color': '#0d3818',
                        'shape': 'ellipse',
                        'width': 80,
                        'height': 80,
                        'font-size': 14,
                        'font-weight': 'bold'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'line-color': '#0056b3',
                        'target-arrow-color': '#0056b3',
                        'target-arrow-shape': 'triangle',
                        'arrow-scale': 1.5,
                        'width': 2,
                        'curve-style': 'bezier',
                        'opacity': 0.8
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 50,
                rankSep: 100,
                animate: false
            }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥–æ–Ω—è–µ–º –≤–∏–¥
        setTimeout(() => {
            cy.fit();
        }, 100);
        
    } catch (error) {
        console.error('Error initializing diagram:', error);
        document.getElementById('templateDiagram').innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∏–∞–≥—Ä–∞–º–º—ã: ' + error.message + '</div>';
    }
}
</script>
{% endif %}
