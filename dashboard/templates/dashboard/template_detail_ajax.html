{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% else %}
<div class="template-detail">
    <h6 class="mb-3">{{ template.name }}</h6>
    
    {% if template.description %}
    <div class="mb-3">
        <strong>Описание:</strong>
        <p class="text-muted">{{ template.description }}</p>
    </div>
    {% endif %}
    
    {% if template.activity_category %}
    <div class="mb-3">
        <strong>Категория:</strong>
        <span class="badge bg-light text-dark border">{{ template.activity_category.name }}</span>
    </div>
    {% endif %}
    
    <!-- Вкладки для переключения между списком и диаграммой -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="stages-tab" data-bs-toggle="tab" data-bs-target="#stages-content" type="button" role="tab">
                <i class="bi bi-list me-1"></i> Список этапов
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="diagram-tab" data-bs-toggle="tab" data-bs-target="#diagram-content" type="button" role="tab">
                <i class="bi bi-diagram-3 me-1"></i> Диаграмма
            </button>
        </li>
    </ul>
    
    <!-- Содержимое вкладок -->
    <div class="tab-content">
        <!-- Вкладка со списком этапов -->
        <div class="tab-pane fade show active" id="stages-content" role="tabpanel">
            <div class="mb-3">
                <strong>Этапы ({{ stages.count }}):</strong>
                <div class="mt-2">
                    {% for stage in stages %}
                    <div class="card card-sm mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ stage.sequence_number }}. {{ stage.name }}</strong>
                                    {% if stage.position %}
                                    <br><small class="text-muted">Должность: {{ stage.position.name }}</small>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        {% if stage.duration_from == stage.duration_to %}
                                            {{ stage.duration_from }} {{ stage.duration_unit.name|default:"" }}
                                        {% else %}
                                            {{ stage.duration_from }}-{{ stage.duration_to }} {{ stage.duration_unit.name|default:"" }}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">Этапы не добавлены</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Вкладка с диаграммой -->
        <div class="tab-pane fade" id="diagram-content" role="tabpanel">
            <div id="templateDiagram" style="width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;"></div>
        </div>
    </div>
    
    <!-- Скрытый контейнер с JSON данными -->
    <script type="application/json" id="stagesData">
{{ stages_json|safe }}
    </script>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

<script>
let diagramInitialized = false;

// Инициализируем диаграмму при переключении на вкладку
document.getElementById('diagram-tab').addEventListener('shown.bs.tab', function() {
    if (!diagramInitialized) {
        initTemplateDiagram();
        diagramInitialized = true;
    }
});

function initTemplateDiagram() {
    try {
        // Получаем JSON данные из скрытого контейнера
        const stagesJsonElement = document.getElementById('stagesData');
        const stagesData = JSON.parse(stagesJsonElement.textContent);
        
        console.log('Stages data:', stagesData);
        
        // Подготавливаем элементы для Cytoscape
        const elements = [];
        
        // Добавляем узел "Старт"
        elements.push({
            data: { id: 'start', label: 'Старт' },
            classes: 'start'
        });
        
        // Добавляем узлы этапов
        stagesData.forEach(stage => {
            const stageName = stage.sequence_number + '. ' + stage.name;
            const position = stage.position || 'Не указана';
            
            // Форматируем длительность
            let durationText = '';
            if (stage.duration_from && stage.duration_to) {
                if (stage.duration_from === stage.duration_to) {
                    durationText = stage.duration_from + ' ' + (stage.duration_unit || '');
                } else {
                    durationText = stage.duration_from + '-' + stage.duration_to + ' ' + (stage.duration_unit || '');
                }
            }
            
            const label = stageName + '\n' + position + '\n' + durationText;
            
            elements.push({
                data: {
                    id: 'stage_' + stage.id,
                    label: label
                }
            });
        });
        
        // Добавляем узел "Стоп"
        elements.push({
            data: { id: 'stop', label: 'Стоп' },
            classes: 'stop'
        });
        
        // Добавляем ребра (связи)
        // От Старта к первому этапу
        if (stagesData.length > 0) {
            elements.push({
                data: {
                    id: 'edge_start_' + stagesData[0].id,
                    source: 'start',
                    target: 'stage_' + stagesData[0].id
                }
            });
        } else {
            // Если нет этапов, соединяем Старт со Стопом
            elements.push({
                data: {
                    id: 'edge_start_stop',
                    source: 'start',
                    target: 'stop'
                }
            });
        }
        
        // От последнего этапа к Стопу
        if (stagesData.length > 0) {
            const lastStage = stagesData[stagesData.length - 1];
            elements.push({
                data: {
                    id: 'edge_' + lastStage.id + '_stop',
                    source: 'stage_' + lastStage.id,
                    target: 'stop'
                }
            });
        }
        
        console.log('Elements:', elements);
        
        // Инициализируем Cytoscape
        const cy = cytoscape({
            container: document.getElementById('templateDiagram'),
            elements: elements,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#2d5016',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': 11,
                        'font-weight': 'bold',
                        'color': 'white',
                        'border-width': 2,
                        'border-color': '#1a3009',
                        'padding': '8px',
                        'text-wrap': 'wrap',
                        'text-max-width': '120px',
                        'shape': 'rectangle',
                        'width': '150px',
                        'height': '100px',
                        'line-height': 1.1
                    }
                },
                {
                    selector: 'node.start',
                    style: {
                        'background-color': '#28a745',
                        'border-color': '#1e7e34',
                        'shape': 'ellipse',
                        'width': 70,
                        'height': 70,
                        'font-size': 12,
                        'font-weight': 'bold'
                    }
                },
                {
                    selector: 'node.stop',
                    style: {
                        'background-color': '#155724',
                        'border-color': '#0d3818',
                        'shape': 'ellipse',
                        'width': 70,
                        'height': 70,
                        'font-size': 12,
                        'font-weight': 'bold'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'line-color': '#0056b3',
                        'target-arrow-color': '#0056b3',
                        'target-arrow-shape': 'triangle',
                        'arrow-scale': 1.2,
                        'width': 2,
                        'curve-style': 'bezier',
                        'opacity': 0.8
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 40,
                rankSep: 80,
                animate: false
            }
        });
        
        // Автоматически подгоняем вид
        setTimeout(() => {
            cy.fit();
            cy.center();
        }, 200);
        
        console.log('Diagram initialized successfully');
        
    } catch (error) {
        console.error('Error initializing diagram:', error);
        const container = document.getElementById('templateDiagram');
        container.innerHTML = '<div style="padding: 20px; color: red;">Ошибка при загрузке диаграммы: ' + error.message + '</div>';
    }
}
</script>
{% endif %}
