{% load dashboard_extras %}
{% with status_color=status_colors|dict_item:task.status %}
<div class="card shadow-sm border-0 kanban-card cursor-grab rounded-3" 
     data-task-id="{{ task.id }}" 
     data-edit-url="{% url 'dashboard:production_order' task.id %}"
     style="transition: all 0.2s; 
            border-left: 4px solid {{ status_color.border }} !important;
            background-color: {{ status_color.bg }};">
    <div class="card-body p-3">
        <!-- Card Header: ID and Priority Badge -->
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="d-flex flex-column gap-1">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted fw-bold" style="font-size: 0.7rem;">#{{ task.external_id|default:"NEW" }}</span>
                    {% if task.source %}
                        <span class="badge bg-light text-muted border rounded-pill ultra-small px-2">{{ task.get_source_display }}</span>
                    {% endif %}
                </div>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    {% if task.priority >= 4 %}
                        <span class="badge text-white border-0 rounded-pill ultra-small px-2" style="width: fit-content; background-color: #E57373;"><i class="bi bi-fire me-1"></i>КРИТИЧНО</span>
                    {% elif task.priority == 3 %}
                        <span class="badge text-dark border-0 rounded-pill ultra-small px-2" style="width: fit-content; background-color: #FFB74D;"><i class="bi bi-clock-history me-1"></i>СРОЧНО</span>
                    {% endif %}
                    
                    {% if task.is_overdue %}
                        <span class="badge rounded-pill ultra-small px-2" style="width: fit-content; background-color: #E57373; color: white;">ПРОСРОЧЕНО</span>
                    {% endif %}
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-link text-muted p-0 border-0" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical" style="font-size: 0.8rem;"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 small">
                    <li><a class="dropdown-item" href="{% url 'dashboard:production_order' task.id %}"><i class="bi bi-eye me-2"></i>Просмотр</a></li>
                    <li><a class="dropdown-item" href="{% url 'dashboard:task_edit' task.id %}"><i class="bi bi-pencil me-2"></i>Редактировать</a></li>
                    {% if user_role == 'ADMIN' or user.is_superuser %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form action="{% url 'dashboard:task_delete' task.id %}" method="post" onsubmit="return confirm('Удалить задачу?');">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>Удалить</button>
                        </form>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        
        <!-- Title -->
        <h6 class="card-title fw-bold mb-2 text-dark mt-2" style="font-size: 0.9rem; line-height: 1.4;">{{ task.product_name|default:task.title }}</h6>
        
        {% if task.client_name %}
        <div class="text-muted mb-2 d-flex align-items-center gap-1" style="font-size: 0.75rem;">
            <i class="bi bi-person text-primary"></i> <span class="text-truncate">{{ task.client_name }}</span>
        </div>
        {% endif %}

        {% if task.description %}
        <p class="text-muted mb-3 small-description mb-3" style="font-size: 0.75rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            {{ task.description }}
        </p>
        {% endif %}

        <!-- Task Metadata -->
        <div class="d-flex justify-content-between align-items-center mt-auto pt-2 border-top">
            <div class="d-flex align-items-center gap-2">
                {% if task.assigned_to %}
                    <div class="avatar-xs bg-primary-soft text-primary border border-primary-subtle rounded-circle d-flex align-items-center justify-content-center fw-bold" 
                         style="width: 26px; height: 26px; font-size: 0.7rem;" 
                         title="Исполнитель: {% if task.assigned_to.get_full_name %}{{ task.assigned_to.get_full_name }}{% else %}{{ task.assigned_to.username }}{% endif %}">
                        {{ task.assigned_to.username|slice:":2"|upper }}
                    </div>
                {% else %}
                    <div class="avatar-xs bg-light text-muted rounded-circle d-flex align-items-center justify-content-center border" 
                         style="width: 26px; height: 26px; font-size: 0.8rem;" title="Не назначено">
                        <i class="bi bi-person"></i>
                    </div>
                {% endif %}
                
                {% if task.deadline %}
                    <div class="d-flex align-items-center gap-1 {% if task.deadline < today %}text-danger fw-bold{% else %}text-muted{% endif %}" style="font-size: 0.7rem;">
                        <i class="bi bi-calendar3"></i>
                        <span>{{ task.deadline|date:"d M" }}</span>
                    </div>
                {% endif %}
            </div>
            
            <div class="d-flex align-items-center gap-2">
                {% with visible_stages=task|filter_stages:user %}
                {% if visible_stages %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-light border rounded-pill ultra-small px-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-list-task me-1"></i> {{ visible_stages.count }}
                    </button>
                    <ul class="dropdown-menu shadow-sm border-0" style="min-width: 250px;">
                        <li class="px-3 py-2 small text-muted">Этапы задачи</li>
                        {% for stage in visible_stages %}
                        <li>
                            <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'dashboard:task_edit' task.id %}#stage-{{ stage.id }}">
                                <span class="small">{{ stage.name }}</span>
                                <span class="badge bg-light text-dark border">
                                    {% if stage.assigned_executor %}
                                        {{ stage.assigned_executor.get_full_name|default:stage.assigned_executor.username|slice:":10" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% endwith %}
                
                {% if task.media_files.count > 0 %}
                    <div class="text-muted" style="font-size: 0.7rem;" title="Файлы">
                        <i class="bi bi-paperclip"></i> {{ task.media_files.count }}
                    </div>
                {% endif %}
{% endwith %}
            </div>
        </div>
    </div>
</div>

<style>
.ultra-small {
    font-size: 0.65rem;
}
.bg-primary-soft {
    background-color: rgba(13, 110, 253, 0.1);
}
.bg-danger-soft {
    background-color: rgba(220, 53, 69, 0.1);
}
.kanban-card {
    background-color: #ffffff;
    min-height: 140px;
    display: flex;
    flex-direction: column;
}
.kanban-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 .5rem 1.5rem rgba(0,0,0,.12)!important;
    z-index: 1;
}
.cursor-grab {
    cursor: grab;
}
.cursor-grabbing {
    cursor: grabbing;
}
</style>
