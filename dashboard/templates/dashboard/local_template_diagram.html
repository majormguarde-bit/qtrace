{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}–î–∏–∞–≥—Ä–∞–º–º–∞ - {{ template.name }}{% endblock %}

{% block content %}
<style>
    #rightSidebar .card {
        flex-shrink: 0;
    }
    #rightSidebar .card-body {
        font-size: 0.9rem;
    }
    #rightSidebar .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
    }
    #rightSidebar .form-select-sm {
        font-size: 0.85rem;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">–î–∏–∞–≥—Ä–∞–º–º–∞: {{ template.name }}</h3>
    <a href="{% url 'dashboard:local_template_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
    </a>
</div>

<div class="row" style="height: calc(100vh - 250px);">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–∏–∞–≥—Ä–∞–º–º–∞ -->
    <div class="col-lg-8">
        <div class="card h-100" style="display: flex; flex-direction: column;">
            <div class="card-header bg-light">
                <h5 class="mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∞–ø–æ–≤ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)</h5>
            </div>
            <div class="card-body flex-grow-1" style="display: flex; flex-direction: column;">
                <!-- Cytoscape –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                <div id="cy" style="flex: 1; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;"></div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ -->
                <div id="statusMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="col-lg-4" style="overflow-y: auto; max-height: calc(100vh - 250px); padding-right: 0.5rem;" id="rightSidebar">
        <!-- –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong><br>
                    {% if total_duration_min == total_duration_max %}
                        <span class="badge bg-info">{{ total_duration_min }} —á–∞—Å–æ–≤</span>
                    {% else %}
                        <span class="badge bg-info">{{ total_duration_min }}-{{ total_duration_max }} —á–∞—Å–æ–≤</span>
                    {% endif %}
                </div>
                <div>
                    <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏:</strong><br>
                    {% for pos in unique_positions %}
                        <span class="badge bg-secondary">{{ pos }}</span>
                    {% empty %}
                        <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–º -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–º</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'dashboard:local_template_edit' template.id %}" class="row g-2">
                    {% csrf_token %}
                    <div class="col-12">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø:</label>
                        <select name="stage_id" class="form-select form-select-sm" required id="stageSelect">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
                            {% for stage in all_stages %}
                            <option value="{{ stage.id }}">{{ stage.sequence_number }}. {{ stage.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–¥–æ–ª–∂–Ω–æ—Å—Ç—å):</label>
                        <select name="position_id" class="form-select form-select-sm" id="positionSelect">
                            <option value="">-- –ù–µ —É–∫–∞–∑–∞–Ω–∞ --</option>
                            {% for position in positions %}
                            <option value="{{ position.id }}">{{ position.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">–í—Ä–µ–º—è (—á–∞—Å–æ–≤):</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" id="durationMin" placeholder="–ú–∏–Ω" min="1" value="1">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" id="durationMax" placeholder="–ú–∞–∫—Å" min="1" value="1">
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-sm w-100" id="submitStageForm">
                            <i class="bi bi-check-circle me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏ -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏</h6>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="editModeToggle">
                    <label class="form-check-label" for="editModeToggle">
                        <small>–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π</small>
                    </label>
                </div>
                
                <div id="editModeInfo" class="text-muted" style="display: none;">
                    <small>
                        <strong>–ê–∫—Ç–∏–≤–µ–Ω —Ä–µ–∂–∏–º:</strong><br>
                        ‚Ä¢ Shift+–ö–ª–∏–∫ –Ω–∞ –±–ª–æ–∫ - –Ω–∞—á–∞—Ç—å —Å–≤—è–∑—å<br>
                        ‚Ä¢ Shift+–ö–ª–∏–∫ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –±–ª–æ–∫ - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–≤—è–∑—å<br>
                        ‚Ä¢ Escape - –æ—Ç–º–µ–Ω–∞
                    </small>
                </div>
                
                <hr class="my-2">
                
                <small class="text-muted d-block">
                    <strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong><br>
                    ‚Ä¢ –ö–æ–ª–µ—Å–æ –º—ã—à–∏ - –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ<br>
                    ‚Ä¢ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ - –ø–∞–Ω–æ—Ä–∞–º–∞<br>
                    ‚Ä¢ –ö–ª–∏–∫ –Ω–∞ –±–ª–æ–∫ - –≤—ã–±—Ä–∞—Ç—å<br>
                    ‚Ä¢ Delete - —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å<br>
                    ‚Ä¢ Ctrl+R - —Å–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥
                </small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –æ —ç—Ç–∞–ø–∞—Ö
const stagesDataJson = '{{ stages_json|escapejs }}';
const stagesData = stagesDataJson ? JSON.parse(stagesDataJson) : [];

// –î–∞–Ω–Ω—ã–µ –æ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö
const positionsDataJson = '{{ positions_json|escapejs }}';
const positionsData = positionsDataJson ? JSON.parse(positionsDataJson) : [];

document.addEventListener('DOMContentLoaded', function() {
    const templateId = parseInt('{{ template.id }}');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–µ–π
    let editMode = false;
    let isDrawing = false;
    let sourceNode = null;
    let tempEdge = null;
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Cytoscape
    const elements = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–∞—Ä—Ç"
    elements.push({
        data: { id: 'start', label: 'üü¢ –°—Ç–∞—Ä—Ç' },
        classes: 'start'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã —ç—Ç–∞–ø–æ–≤
    stagesData.forEach(stage => {
        const stageName = stage.sequence_number + '. ' + stage.name;
        const position = stage.position || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        
        let durationText = '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        if (stage.duration_from && stage.duration_to) {
            if (stage.duration_from === stage.duration_to) {
                durationText = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + stage.duration_from + ' ' + (stage.duration_unit || '');
            } else {
                durationText = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + stage.duration_from + '-' + stage.duration_to + ' ' + (stage.duration_unit || '');
            }
        }
        
        const label = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' + stageName + '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' + position + '\n' + durationText;
        
        elements.push({
            data: {
                id: 'stage_' + stage.id,
                label: label,
                stageName: stageName,
                position: position,
                duration: durationText
            }
        });
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –¥–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ —Ä—è–¥–æ–º
        if (stage.materials && stage.materials.length > 0) {
            const materialsLabel = stage.materials.map(m => m.quantity + ' ' + m.unit + ' ' + m.name).join('\n');
            elements.push({
                data: {
                    id: 'materials_' + stage.id,
                    label: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:\n' + materialsLabel
                },
                classes: 'materials'
            });
            
            elements.push({
                data: {
                    id: 'edge_stage_materials_' + stage.id,
                    source: 'materials_' + stage.id,
                    target: 'stage_' + stage.id
                },
                classes: 'materials-edge'
            });
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–µ–ª "–°—Ç–æ–ø"
    elements.push({
        data: { id: 'stop', label: 'üî¥ –°—Ç–æ–ø' },
        classes: 'stop'
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Å–≤—è–∑–∏)
    if (stagesData.length > 0) {
        elements.push({
            data: {
                id: 'edge_start_' + stagesData[0].id,
                source: 'start',
                target: 'stage_' + stagesData[0].id
            }
        });
    } else {
        elements.push({
            data: {
                id: 'edge_start_stop',
                source: 'start',
                target: 'stop'
            }
        });
    }
    
    // –û—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–ø–∞ –∫ –°—Ç–æ–ø—É
    if (stagesData.length > 0) {
        const lastStage = stagesData[stagesData.length - 1];
        elements.push({
            data: {
                id: 'edge_' + lastStage.id + '_stop',
                source: 'stage_' + lastStage.id,
                target: 'stop'
            }
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Cytoscape
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node:not(:parent)',
                style: {
                    'background-color': '#2d5016',
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': 24,
                    'font-weight': 'bold',
                    'color': 'white',
                    'border-width': 2,
                    'border-color': '#1a3009',
                    'padding': '20px',
                    'text-wrap': 'wrap',
                    'text-max-width': '260px',
                    'shape': 'rectangle',
                    'width': '336px',
                    'height': '220px',
                    'line-height': 1.2
                }
            },
            {
                selector: 'node:active',
                style: {
                    'border-width': 3,
                    'border-color': '#ff9800'
                }
            },
            {
                selector: 'node.start',
                style: {
                    'background-color': '#28a745',
                    'border-color': '#1e7e34',
                    'shape': 'ellipse',
                    'width': 120,
                    'height': 120,
                    'font-size': 20,
                    'font-weight': 'bold'
                }
            },
            {
                selector: 'node.stop',
                style: {
                    'background-color': '#155724',
                    'border-color': '#0d3818',
                    'shape': 'ellipse',
                    'width': 120,
                    'height': 120,
                    'font-size': 20,
                    'font-weight': 'bold'
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'background-color': '#3d7024',
                    'color': 'white',
                    'border-color': '#ff9800',
                    'border-width': 3
                }
            },
            {
                selector: 'edge',
                style: {
                    'line-color': '#0056b3',
                    'target-arrow-color': '#0056b3',
                    'target-arrow-shape': 'triangle',
                    'arrow-scale': 2,
                    'width': 3,
                    'curve-style': 'bezier',
                    'opacity': 0.8
                }
            },
            {
                selector: 'edge:active',
                style: {
                    'line-color': '#ff9800',
                    'target-arrow-color': '#ff9800',
                    'width': 4,
                    'opacity': 1
                }
            },
            {
                selector: 'edge:selected',
                style: {
                    'line-color': '#ff9800',
                    'target-arrow-color': '#ff9800',
                    'width': 4,
                    'opacity': 1
                }
            },
            {
                selector: 'node.materials',
                style: {
                    'background-color': '#f0f0f0',
                    'border-color': '#666',
                    'border-width': 3,
                    'color': '#333',
                    'font-size': 12,
                    'font-weight': 'normal',
                    'padding': '15px',
                    'text-max-width': '200px',
                    'width': '220px',
                    'height': 'auto',
                    'min-height': '120px',
                    'text-wrap': 'wrap',
                    'line-height': 1.3
                }
            },
            {
                selector: 'edge.materials-edge',
                style: {
                    'line-color': '#999',
                    'target-arrow-color': '#999',
                    'target-arrow-shape': 'triangle',
                    'line-style': 'dashed',
                    'width': 2,
                    'opacity': 0.7,
                    'arrow-scale': 1.5
                }
            }
        ],
        layout: {
            name: 'breadthfirst',
            directed: true,
            animate: true,
            animationDuration: 500,
            spacingFactor: 1.5,
            roots: '#start'
        },
        wheelSensitivity: 0.1,
        minZoom: 0.1,
        maxZoom: 3
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –±–ª–æ–∫–æ–≤
    const savedPositions = localStorage.getItem('diagramPositions_' + templateId);
    if (savedPositions) {
        try {
            const positions = JSON.parse(savedPositions);
            cy.nodes().forEach(node => {
                if (positions[node.id()]) {
                    node.position(positions[node.id()]);
                }
            });
        } catch (e) {
            console.error('Error loading saved positions:', e);
        }
    } else {
        cy.layout({ name: 'breadthfirst', directed: true, animate: true, animationDuration: 500, spacingFactor: 1.5, roots: '#start' }).run();
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —É–∑–ª–æ–≤
    cy.on('free', 'node', function(evt) {
        const positions = {};
        cy.nodes().forEach(node => {
            positions[node.id()] = node.position();
        });
        localStorage.setItem('diagramPositions_' + templateId, JSON.stringify(positions));
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —É–∑–µ–ª
    cy.on('tap', function(evt) {
        const target = evt.target;
        
        if (!target || !target.isNode || !target.isNode()) {
            return;
        }
        
        const node = target;
        const nodeId = node.id();
        
        if (editMode) {
            if (isDrawing) {
                const targetNode = node;
                const sourceId = sourceNode.id();
                const targetId = targetNode.id();
                
                if (sourceId === targetId) {
                    showStatus('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è', 'error');
                    cancelDrawing();
                    return;
                }
                
                if (targetId === 'start') {
                    showStatus('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –∫ –°—Ç–∞—Ä—Ç—É', 'error');
                    cancelDrawing();
                    return;
                }
                
                const newEdgeId = 'edge_' + sourceId + '_' + targetId;
                const existingEdge = cy.$('#' + newEdgeId);
                
                if (existingEdge.length === 0) {
                    cy.add({
                        data: {
                            id: newEdgeId,
                            source: sourceId,
                            target: targetId
                        }
                    });
                    showStatus('–°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞', 'success');
                } else {
                    showStatus('–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
                }
                
                cancelDrawing();
                return;
            }
            
            if (evt.originalEvent.shiftKey) {
                if (nodeId === 'start' || nodeId === 'stop') {
                    showStatus('–ù–µ–ª—å–∑—è —Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —É–∑–ª–æ–≤', 'error');
                    return;
                }
                
                sourceNode = node;
                isDrawing = true;
                node.style('border-width', 4);
                node.style('border-color', '#0056b3');
                node.style('background-color', '#0056b3');
                showStatus('–°–≤—è–∑—å –Ω–∞—á–∞—Ç–∞. –ö–ª–∏–∫ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –±–ª–æ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', 'info');
                return;
            }
        }
        
        if (nodeId === 'start' || nodeId === 'stop') {
            return;
        }
        
        const stageId = nodeId.replace('stage_', '');
        document.getElementById('stageSelect').value = stageId;
        
        const stage = stagesData.find(s => s.id == stageId);
        if (stage) {
            if (stage.position_id) {
                document.getElementById('positionSelect').value = stage.position_id;
            } else {
                document.getElementById('positionSelect').value = '';
            }
            
            document.getElementById('durationMin').value = stage.duration_from || 1;
            document.getElementById('durationMax').value = stage.duration_to || 1;
        }
        
        showStatus('–≠—Ç–∞–ø –≤—ã–±—Ä–∞–Ω', 'info');
    });
    
    function cancelDrawing() {
        if (sourceNode) {
            sourceNode.style('border-width', 2);
            sourceNode.style('border-color', '#1a3009');
            sourceNode.style('background-color', '#2d5016');
        }
        isDrawing = false;
        sourceNode = null;
    }
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (isDrawing) {
                cancelDrawing();
                showStatus('–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
            }
        }
        
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            cy.fit();
            showStatus('–í–∏–¥ —Å–±—Ä–æ—à–µ–Ω', 'info');
        }
    });
    
    document.getElementById('editModeToggle').addEventListener('change', function(e) {
        editMode = e.target.checked;
        document.getElementById('editModeInfo').style.display = editMode ? 'block' : 'none';
        
        if (editMode) {
            showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'info');
        } else {
            cancelDrawing();
            showStatus('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
        }
    });
    
    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        const alertClass = type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : type === 'success' ? 'alert-success' : 'alert-info';
        statusDiv.innerHTML = `<div class="alert ${alertClass} mb-0">${message}</div>`;
    }
});
</script>
{% endblock %}
