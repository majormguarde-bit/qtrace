{% extends 'dashboard/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold"><i class="bi bi-list-check me-2 text-primary"></i>Задачи</h2>
    <a href="{% url 'dashboard:task_create' %}" class="btn btn-primary rounded-pill px-4">
        <i class="bi bi-plus-lg me-1"></i> Новая задача
    </a>
</div>

<!-- Filters Panel -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 text-muted small text-uppercase fw-bold">Фильтры и поиск</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#clearAllModal" title="Удалить все задачи">
                <i class="bi bi-trash me-1"></i> Очистить список
            </button>
        </div>
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small text-muted">Поиск по названию</label>
                <input type="text" name="search" class="form-control" placeholder="Введите название..." value="{{ current_search }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Статус</label>
                <select name="status" class="form-select">
                    <option value="">-- Все статусы --</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if employees %}
            <div class="col-md-3">
                <label class="form-label small text-muted">Исполнитель</label>
                <select name="assigned_to" class="form-select">
                    <option value="">-- Все исполнители --</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if current_assigned_to == emp.id|stringformat:"s" %}selected{% endif %}>{{ emp.get_full_name|default:emp.username }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel me-1"></i> Фильтр
                </button>
            </div>
            {% if current_search or current_status or current_assigned_to %}
            <div class="col-md-2">
                <a href="{% url 'dashboard:task_list' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-x-circle me-1"></i> Сброс
                </a>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- Bulk Actions Panel -->
<div class="card shadow-sm border-0 mb-4 d-none" id="bulk-actions-panel">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <span id="selected-count">0</span> задач выбрано
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-danger btn-sm" id="delete-selected-btn" data-bs-toggle="modal" data-bs-target="#deleteSelectedModal">
                <i class="bi bi-trash me-1"></i> Удалить выбранные
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-selection-btn">
                <i class="bi bi-x-circle me-1"></i> Отменить выбор
            </button>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4" style="width: 40px;">
                            <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                        </th>
                        <th class="ps-4" style="width: 40px;"></th>
                        <th>Заголовок</th>
                        <th>Статус</th>
                        <th>Контролирует</th>
                        <th class="pe-4">Создано</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    {% for task in tasks %}
                    <!-- Main Row -->
                    <tr class="task-row cursor-pointer" id="task-{{ task.id }}" data-bs-toggle="collapse" data-bs-target="#task-details-{{ task.id }}" aria-expanded="false">
                        <td class="ps-4" onclick="event.stopPropagation();">
                            <input type="checkbox" class="form-check-input task-checkbox" value="{{ task.id }}" data-task-id="{{ task.id }}">
                        </td>
                        <td class="ps-4">
                            <i class="bi bi-chevron-right chevron-icon transition-300"></i>
                        </td>
                        <td>
                            <div class="fw-bold text-dark">{{ task.title }}</div>
                        </td>
                        <td class="task-status-badge">
                            {% if task.status == 'OPEN' %}
                            <span class="badge bg-primary-soft text-primary border border-primary-subtle px-3 rounded-pill">Открыта</span>
                            {% elif task.status == 'PAUSE' %}
                            <span class="badge bg-warning-soft text-warning-emphasis border border-warning-subtle px-3 rounded-pill">Пауза</span>
                            {% elif task.status == 'CONTINUE' %}
                            <span class="badge bg-info-soft text-info-emphasis border border-info-subtle px-3 rounded-pill">В работе</span>
                            {% elif task.status == 'IMPORTANT' %}
                            <span class="badge bg-danger-soft text-danger border border-danger-subtle px-3 rounded-pill">Важно</span>
                            {% elif task.status == 'CLOSE' %}
                            <span class="badge bg-success-soft text-success border border-success-subtle px-3 rounded-pill">Закрыта</span>
                            {% endif %}
                        </td>
                        <td class="text-muted">{% if task.supervisor %}{{ task.supervisor.get_full_name|default:task.supervisor.username }}{% else %}<span class="text-muted-50">Не назначен</span>{% endif %}</td>
                        <td class="pe-4 text-muted small">{{ task.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    
                    <!-- Details Row (Accordion) -->
                    <tr class="collapse-row">
                        <td colspan="5" class="p-0 border-0">
                            <div class="collapse" id="task-details-{{ task.id }}">
                                <div class="p-4 bg-light-subtle border-bottom">
                                    <div class="row">
                                        <div class="col-lg-8">
                                            <h6 class="text-muted small text-uppercase fw-bold mb-2">Описание</h6>
                                            <div class="text-dark mb-3 lead-sm">{{ task.description|linebreaks|default:"Нет описания" }}</div>
                                            
                                            <div class="mb-4">
                                                <span class="text-muted small">Кто контролирует:</span>
                                                {% if task.supervisor %}
                                                    <span class="fw-medium">{{ task.supervisor.get_full_name }}</span>
                                                    {% if task.supervisor.position %}
                                                        <span class="text-muted small">({{ task.supervisor.position.name }})</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted fst-italic">Не назначен</span>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Task Control Buttons -->
                                            <h6 class="text-muted small text-uppercase fw-bold mb-2">Управление статусом</h6>
                                            <div class="task-controls d-flex flex-wrap gap-2 mb-4">
                                                <button class="btn btn-white btn-sm btn-status border shadow-sm px-3" 
                                                        data-task-id="{{ task.id }}" data-status="PAUSE">
                                                    <i class="bi bi-pause-fill text-warning"></i> Пауза
                                                </button>
                                                <button class="btn btn-white btn-sm btn-status border shadow-sm px-3" 
                                                        data-task-id="{{ task.id }}" data-status="CONTINUE">
                                                    <i class="bi bi-play-fill text-info"></i> Работа
                                                </button>
                                                <button class="btn btn-white btn-sm btn-status border shadow-sm px-3" 
                                                        data-task-id="{{ task.id }}" data-status="IMPORTANT">
                                                    <i class="bi bi-exclamation-triangle text-danger"></i> Важно
                                                </button>
                                                <button class="btn btn-white btn-sm btn-status border shadow-sm px-3" 
                                                        data-task-id="{{ task.id }}" data-status="CLOSE">
                                                    <i class="bi bi-check-lg text-success"></i> Закрыть
                                                </button>
                                            </div>

                                            <div class="d-flex align-items-center gap-3">
                                                <a href="{% url 'dashboard:task_edit' task.pk %}?next={{ request.path }}" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                                                    <i class="bi bi-pencil-square me-1"></i> Редактировать
                                                </a>
                                            </div>
                                        </div>
                                        
                                            <div class="col-lg-4 border-start-lg">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="text-muted small text-uppercase fw-bold mb-0">Этапы выполнения</h6>
                                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="showAddStageForm({{ task.id }})">
                                                        <i class="bi bi-plus-circle me-1"></i>Этап
                                                    </button>
                                                </div>

                                                <div id="add-stage-form-{{ task.id }}" class="mb-3 d-none">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" placeholder="Название нового этапа..." id="new-stage-name-{{ task.id }}">
                                                        <button class="btn btn-primary" onclick="addNewStage({{ task.id }})">Добавить</button>
                                                        <button class="btn btn-outline-secondary" onclick="hideAddStageForm({{ task.id }})">✕</button>
                                                    </div>
                                                </div>

                                                <div class="task-stages" id="task-stages-list-{{ task.id }}">
                                                    {% for stage in task.stages.all %}
                                                    <div class="stage-container mb-2">
                                                        <div class="stage-item d-flex align-items-center p-2 rounded border bg-white shadow-sm {% if stage.is_worker_added %}border-info-subtle{% endif %}" 
                                                             id="stage-{{ stage.id }}" 
                                                             onclick="toggleStageForm({{ stage.id }})" 
                                                             style="cursor: pointer;">
                                                            <div class="stage-checkbox me-3" onclick="event.stopPropagation(); toggleStage({{ stage.id }})">
                                                                {% if stage.is_completed %}
                                                                <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                                                {% else %}
                                                                <i class="bi bi-circle text-muted fs-5"></i>
                                                                {% endif %}
                                                            </div>
                                                            <div class="stage-info flex-grow-1">
                                                                <div class="{% if stage.is_completed %}text-decoration-line-through text-muted{% endif %} fw-medium small">
                                                                    {{ stage.name }}
                                                                    {% if stage.is_worker_added %}
                                                                    <span class="badge bg-info-soft text-info ultra-small ms-1">Сотрудник</span>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="text-muted ultra-small d-flex align-items-center gap-2">
                                                                    <span><i class="bi bi-clock me-1"></i>{{ stage.duration_minutes }} мин.</span>
                                                                    <span class="stage-status-label-{{ stage.id }} badge {% if stage.status == 'COMPLETED' %}bg-success-soft text-success{% elif stage.status == 'IN_PROGRESS' %}bg-primary-soft text-primary{% elif stage.status == 'FAILED' %}bg-danger-soft text-danger{% else %}bg-light text-muted{% endif %} px-2">
                                                                        {{ stage.get_status_display }}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div class="ms-2 text-muted">
                                                                <i class="bi bi-chevron-down small opacity-50"></i>
                                                            </div>
                                                        </div>

                                                        <!-- Stage Detail Form (Hidden by default) -->
                                                        <div id="stage-form-{{ stage.id }}" class="stage-detail-form d-none p-3 border border-top-0 rounded-bottom bg-white shadow-sm mt-n1">
                                                            <h6 class="ultra-small text-uppercase fw-bold text-muted mb-3">Управление этапом</h6>
                                                            
                                                            <div class="mb-3">
                                                                <label class="ultra-small fw-bold text-muted d-block mb-2">Статус этапа</label>
                                                                <div class="d-flex flex-wrap gap-2">
                                                                    <button onclick="updateStageStatus({{ stage.id }}, 'PENDING')" class="btn btn-outline-secondary btn-xs status-btn-PENDING-{{ stage.id }} {% if stage.status == 'PENDING' %}active{% endif %}">В планах</button>
                                                                    <button onclick="updateStageStatus({{ stage.id }}, 'IN_PROGRESS')" class="btn btn-outline-primary btn-xs status-btn-IN_PROGRESS-{{ stage.id }} {% if stage.status == 'IN_PROGRESS' %}active{% endif %}">В работе</button>
                                                                    <button onclick="updateStageStatus({{ stage.id }}, 'COMPLETED')" class="btn btn-outline-success btn-xs status-btn-COMPLETED-{{ stage.id }} {% if stage.status == 'COMPLETED' %}active{% endif %}">Завершен</button>
                                                                    <button onclick="updateStageStatus({{ stage.id }}, 'FAILED')" class="btn btn-outline-danger btn-xs status-btn-FAILED-{{ stage.id }} {% if stage.status == 'FAILED' %}active{% endif %}">Проблема</button>
                                                                </div>
                                                            </div>

                                                            <!-- Stage Media Files -->
                                                            <div class="mb-3">
                                                                <label class="ultra-small fw-bold text-muted d-block mb-2">Файлы этапа</label>
                                                                <div class="d-flex flex-wrap gap-2" id="stage-media-list-{{ stage.id }}">
                                                                    {% for media in stage.media.all %}
                                                                    <div class="media-preview-container position-relative">
                                                                        <a href="{{ media.file.url }}" target="_blank" class="d-block border rounded overflow-hidden shadow-sm hover-opacity transition-200" title="{{ media.title }}">
                                                                            {% if ".mp4" in media.file.name or ".mov" in media.file.name or ".avi" in media.file.name %}
                                                                                <div class="bg-dark d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                                                    <i class="bi bi-play-btn-fill text-white fs-4"></i>
                                                                                </div>
                                                                            {% else %}
                                                                                <img src="{{ media.file.url }}" alt="{{ media.title }}" style="width: 60px; height: 60px; object-fit: cover;">
                                                                            {% endif %}
                                                                        </a>
                                                                    </div>
                                                                    {% empty %}
                                                                    <div class="text-muted small italic opacity-50 py-2 no-media-text-{{ stage.id }}">Нет файлов</div>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>

                                                            <div class="d-flex gap-2">
                                                                <button type="button" class="btn btn-sm btn-outline-primary flex-grow-1" 
                                                                        onclick="triggerMediaUpload({{ stage.id }}, 'image/*')">
                                                                    <i class="bi bi-camera me-1"></i> Фото
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger flex-grow-1" 
                                                                        onclick="triggerMediaUpload({{ stage.id }}, 'video/*')">
                                                                    <i class="bi bi-video me-1"></i> Видео
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-clipboard-x display-1 opacity-10 d-block mb-3"></i>
                            Задач пока нет
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; }
    .transition-300 { transition: all 0.3s ease; }
    .task-row[aria-expanded="true"] .chevron-icon {
        transform: rotate(90deg);
        color: var(--bs-primary);
    }
    .task-row:hover { background-color: rgba(var(--bs-primary-rgb), 0.02) !important; }
    .ultra-small { font-size: 0.7rem; }
    .lead-sm { font-size: 0.95rem; line-height: 1.6; }
    .btn-white { background: #fff; border-color: #dee2e6; }
    .btn-white:hover { background: #f8f9fa; border-color: #c1c9d0; }
    
    .hover-opacity:hover { opacity: 0.8; }
    .transition-200 { transition: all 0.2s ease; }
    .media-preview-container img, .media-preview-container div {
        border: 1px solid #eee;
    }
    
    @media (min-width: 992px) {
        .border-start-lg { border-left: 1px solid #dee2e6 !important; }
    }
</style>


{% if is_paginated %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Назад</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">{{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Вперед</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Delete Selected Modal -->
<div class="modal fade" id="deleteSelectedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Удаление выбранных задач</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить <strong id="delete-count">0</strong> выбранных задач?</p>
                <p class="text-muted small">Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form method="post" action="{% url 'dashboard:delete_selected_tasks' %}" style="display: inline;">
                    {% csrf_token %}
                    <div id="task-ids-container"></div>
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Clear All Modal -->
<div class="modal fade" id="clearAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Очистить все задачи</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger"><strong>⚠️ Внимание!</strong></p>
                <p>Вы уверены, что хотите удалить <strong>ВСЕ</strong> задачи?</p>
                <p class="text-muted small">Это действие нельзя отменить и удалит все задачи в системе.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form method="post" action="{% url 'dashboard:clear_all_tasks' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Удалить все</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Управление выбором задач
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const taskCheckboxes = document.querySelectorAll('.task-checkbox');
    const bulkActionsPanel = document.getElementById('bulk-actions-panel');
    const selectedCountSpan = document.getElementById('selected-count');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const clearSelectionBtn = document.getElementById('clear-selection-btn');
    const deleteCountSpan = document.getElementById('delete-count');
    const taskIdsContainer = document.getElementById('task-ids-container');
    
    function updateBulkActionsPanel() {
        const selectedCount = document.querySelectorAll('.task-checkbox:checked').length;
        
        if (selectedCount > 0) {
            bulkActionsPanel.classList.remove('d-none');
            selectedCountSpan.textContent = selectedCount;
            deleteCountSpan.textContent = selectedCount;
            
            // Обновляем скрытые поля с ID задач
            taskIdsContainer.innerHTML = '';
            document.querySelectorAll('.task-checkbox:checked').forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'task_ids';
                input.value = checkbox.value;
                taskIdsContainer.appendChild(input);
            });
        } else {
            bulkActionsPanel.classList.add('d-none');
        }
    }
    
    // Select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        taskCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActionsPanel();
    });
    
    // Individual checkboxes
    taskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActionsPanel();
            
            // Update select all checkbox state
            const allChecked = Array.from(taskCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(taskCheckboxes).some(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        });
    });
    
    // Clear selection button
    clearSelectionBtn.addEventListener('click', function() {
        selectAllCheckbox.checked = false;
        taskCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateBulkActionsPanel();
    });
    
    // Автоматическое раскрытие аккордеона при переходе по якорю
    if (window.location.hash) {
        const taskId = window.location.hash.substring(1); // Убираем #
        const taskRow = document.getElementById(taskId);
        
        if (taskRow) {
            // Прокручиваем к задаче
            taskRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Раскрываем аккордеон
            const collapseTarget = taskRow.getAttribute('data-bs-target');
            if (collapseTarget) {
                const collapseElement = document.querySelector(collapseTarget);
                if (collapseElement) {
                    // Используем Bootstrap Collapse API
                    const bsCollapse = new bootstrap.Collapse(collapseElement, {
                        toggle: true
                    });
                    
                    // Обновляем aria-expanded
                    taskRow.setAttribute('aria-expanded', 'true');
                    
                    // Подсвечиваем строку
                    taskRow.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
                    setTimeout(() => {
                        taskRow.style.backgroundColor = '';
                    }, 2000);
                }
            }
        }
    }
});
</script>
{% endblock %}
