{% extends 'dashboard/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h4 class="mb-0">{% if form.instance.pk %}Редактирование задачи{% else %}Новая задача{% endif %}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if request.GET.next %}
                    <input type="hidden" name="next" value="{{ request.GET.next }}">
                    {% endif %}
                    
                    <!-- Выбор шаблона -->
                    <div class="mb-4 p-3 bg-light rounded border-start border-primary border-4">
                        <h6 class="mb-3"><i class="bi bi-file-earmark-text me-2"></i>Использовать шаблон (опционально)</h6>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label small text-muted">Выберите шаблон</label>
                                <select id="templateSelect" class="form-select">
                                    <option value="">-- Создать с нуля --</option>
                                    {% for template in templates %}
                                    <option value="{{ template.id }}" data-name="{{ template.name }}" data-description="{{ template.description }}">
                                        {{ template.name }} ({{ template.category.name }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small text-muted">&nbsp;</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showAllCategories">
                                    <label class="form-check-label" for="showAllCategories">
                                        Показать все категории
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% for field in form %}
                    <div class="mb-3 position-relative">
                        <label class="form-label d-flex justify-content-between">
                            {{ field.label }}
                            {% if field.name == 'description' %}
                            <button type="button" class="btn btn-sm btn-outline-info border-0 p-0" onclick="improveDescription()" title="Улучшить описание с помощью AI">
                                <i class="bi bi-magic me-1"></i>AI Помощник
                            </button>
                            {% endif %}
                        </label>
                        {{ field }}
                        {% if field.name == 'description' %}
                        <div id="ai-task-loading" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                        {% endif %}
                        {% if field.errors %}
                        <div class="text-danger small mt-1">
                            {{ field.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <hr>
                    <div id="stages-panel" class="d-none">
                        <h5 class="mb-3">Этапы выполнения</h5>
                        {{ stages.management_form }}
                        <div id="stages-container">
                            {% for stage_form in stages %}
                            <div class="stage-form mb-3 border p-3 rounded bg-light">
                                {{ stage_form.id }}
                                {{ stage_form.position_name }}
                                {{ stage_form.materials_info }}
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <label class="form-label small text-muted">Название этапа</label>
                                        {{ stage_form.name }}
                                        {% if stage_form.name.errors %}
                                        <div class="text-danger small">{{ stage_form.name.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Длительность</label>
                                        <div class="input-group">
                                            {{ stage_form.duration_value }}
                                            {{ stage_form.duration_unit }}
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Исполнитель</label>
                                        {{ stage_form.assigned_to }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Должность</label>
                                        {{ stage_form.position_name }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small text-muted">Порядок</label>
                                        {{ stage_form.order }}
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end justify-content-center">
                                        {% if stages.can_delete %}
                                        <div class="form-check mb-2">
                                            {{ stage_form.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ stage_form.DELETE.id_for_label }}">
                                                <i class="bi bi-trash"></i>
                                            </label>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row g-2 mt-1">
                                    <div class="col-md-3">
                                        <label class="form-label small text-muted">Длительность (текст)</label>
                                        {{ stage_form.duration_text }}
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label small text-muted d-flex justify-content-between align-items-center">
                                            <span>Материалы</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-materials-btn" data-form-num="{{ forloop.counter0 }}">
                                                <i class="bi bi-pencil"></i> Редактировать
                                            </button>
                                        </label>
                                        <div class="materials-display small text-muted p-2 border rounded bg-white" data-form-num="{{ forloop.counter0 }}"></div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mb-4" id="add-stage">
                        <i class="bi bi-plus-lg me-1"></i>Добавить этап
                    </button>

                    <div class="d-flex justify-content-end gap-2">
                        {% if request.GET.next %}
                        <a href="{{ request.GET.next }}" class="btn btn-secondary">Назад</a>
                        {% else %}
                        <a href="{% url 'dashboard:task_list' %}" class="btn btn-secondary">Назад</a>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">{% if form.instance.pk %}Сохранить{% else %}Создать{% endif %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования материалов -->
<div class="modal fade" id="materialsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование материалов этапа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="materials-list"></div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-material-btn">
                    <i class="bi bi-plus-lg"></i> Добавить материал
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="save-materials-btn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
// Глобальные переменные
let positionsData = [];
let materialsData = [];
let unitsData = [];
let employeesData = [];
let currentEditingStageNum = null;

// Загрузка справочников при загрузке страницы
document.addEventListener('DOMContentLoaded', async function() {
    await loadPositions();
    await loadMaterials();
    await loadUnits();
    await loadEmployees();
    updateAllPositionSelects();
    updateAllMaterialsDisplays();
    updateStagesPanelVisibility();
});

// Загрузка должностей
async function loadPositions() {
    try {
        const response = await fetch('/api/positions/');
        positionsData = await response.json();
    } catch (error) {
        console.error('Ошибка загрузки должностей:', error);
    }
}

// Загрузка материалов
async function loadMaterials() {
    try {
        const response = await fetch('/api/materials/');
        materialsData = await response.json();
    } catch (error) {
        console.error('Ошибка загрузки материалов:', error);
    }
}

// Загрузка единиц измерения
async function loadUnits() {
    try {
        const response = await fetch('/api/units/');
        unitsData = await response.json();
    } catch (error) {
        console.error('Ошибка загрузки единиц измерения:', error);
    }
}

// Загрузка сотрудников
async function loadEmployees() {
    try {
        const response = await fetch('/api/employees/');
        employeesData = await response.json();
    } catch (error) {
        console.error('Ошибка загрузки сотрудников:', error);
    }
}

// Обновление видимости панели этапов
function updateStagesPanelVisibility() {
    const container = document.getElementById('stages-container');
    const panel = document.getElementById('stages-panel');
    const stageCount = container.querySelectorAll('.stage-form').length;
    
    if (stageCount > 0) {
        panel.classList.remove('d-none');
    } else {
        panel.classList.add('d-none');
    }
}

// Обновление всех выпадающих списков должностей
function updateAllPositionSelects() {
    document.querySelectorAll('.position-select').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">-- Не выбрано --</option>';
        positionsData.forEach(pos => {
            const option = document.createElement('option');
            option.value = pos.id;
            option.textContent = pos.name;
            if (pos.id == currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    });
}

// Обновление всех отображений материалов
function updateAllMaterialsDisplays() {
    document.querySelectorAll('.materials-display').forEach(display => {
        const formNum = display.dataset.formNum;
        const materialsInput = document.getElementById(`id_stages-${formNum}-materials_info`);
        if (materialsInput) {
            const materials = JSON.parse(materialsInput.value || '[]');
            updateMaterialsDisplay(formNum, materials);
        }
    });
}

// Обновление отображения материалов для этапа
function updateMaterialsDisplay(formNum, materials) {
    const display = document.querySelector(`.materials-display[data-form-num="${formNum}"]`);
    if (!display) return;
    
    if (materials.length === 0) {
        display.innerHTML = '<span class="text-muted fst-italic">Нет материалов</span>';
    } else {
        display.innerHTML = materials.map(m => `${m.name}: ${m.quantity} ${m.unit}`).join(', ');
    }
}

async function improveDescription() {
    const descField = document.querySelector('textarea[name="description"]');
    const loading = document.getElementById('ai-task-loading');
    const currentText = descField.value.trim();

    if (!currentText) {
        alert('Пожалуйста, введите краткое описание, чтобы AI мог его развернуть.');
        return;
    }

    loading.classList.remove('d-none');
    descField.style.opacity = '0.5';

    try {
        const response = await fetch('/ai/api/chat/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                prompt: currentText, 
                context: "task_expansion" 
            })
        });
        const data = await response.json();
        if (data.status === 'success') {
            descField.value = data.response;
        }
    } catch (error) {
        alert('Ошибка при работе с AI.');
    } finally {
        loading.classList.add('d-none');
        descField.style.opacity = '1';
    }
}

// Выбор шаблона
document.getElementById('templateSelect').addEventListener('change', async function() {
    const templateId = this.value;
    if (!templateId) return;
    
    const selectedOption = this.options[this.selectedIndex];
    const templateName = selectedOption.dataset.name;
    const templateDescription = selectedOption.dataset.description;
    
    // Предзаполняем название и описание
    const titleField = document.querySelector('input[name="title"]');
    const descField = document.querySelector('textarea[name="description"]');
    
    if (titleField && !titleField.value) {
        titleField.value = templateName;
    }
    if (descField && !descField.value) {
        descField.value = templateDescription;
    }
    
    // Загружаем этапы из шаблона
    try {
        const response = await fetch(`/template/${templateId}/stages/`);
        const data = await response.json();
        
        if (data.status === 'success' && data.stages && data.stages.length > 0) {
            // Очищаем существующие этапы
            const container = document.getElementById('stages-container');
            container.innerHTML = '';
            
            const totalForms = document.getElementById('id_stages-TOTAL_FORMS');
            
            // Добавляем этапы из шаблона
            data.stages.forEach((stage, index) => {
                addStageForm(index, stage);
            });
            
            totalForms.value = data.stages.length;
        }
    } catch (error) {
        console.error('Ошибка загрузки этапов шаблона:', error);
    }
});

// Функция для добавления формы этапа
function addStageForm(formNum, stageData = {}) {
    const container = document.getElementById('stages-container');
    
    const name = stageData.name || '';
    const duration = stageData.duration_minutes || 0;
    const order = stageData.order || formNum;
    const positionId = stageData.position_id || '';
    const positionName = stageData.position || '';
    const durationText = stageData.duration_text || '';
    const materials = stageData.materials || [];
    const assignedToId = stageData.assigned_to_id || '';
    
    // Формируем опции для выпадающего списка должностей
    let positionOptions = '<option value="">-- Не выбрано --</option>';
    positionsData.forEach(pos => {
        const selected = pos.id == positionId ? 'selected' : '';
        positionOptions += `<option value="${pos.id}" ${selected}>${pos.name}</option>`;
    });
    
    // Формируем опции для выпадающего списка сотрудников
    let employeeOptions = '<option value="">-- Не выбран --</option>';
    employeesData.forEach(emp => {
        const selected = emp.id == assignedToId ? 'selected' : '';
        employeeOptions += `<option value="${emp.id}" ${selected}>${emp.name}${emp.position ? ' (' + emp.position + ')' : ''}</option>`;
    });
    
    const formHtml = `
        <div class="stage-form mb-3 border p-3 rounded bg-light">
            <input type="hidden" name="stages-${formNum}-id" id="id_stages-${formNum}-id">
            <input type="hidden" name="stages-${formNum}-position_name" value="${positionName}" id="id_stages-${formNum}-position_name">
            <input type="hidden" name="stages-${formNum}-materials_info" value='${JSON.stringify(materials)}' id="id_stages-${formNum}-materials_info">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Название этапа</label>
                    <input type="text" name="stages-${formNum}-name" value="${name}" class="form-control" maxlength="200" required id="id_stages-${formNum}-name">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Мин</label>
                    <input type="number" name="stages-${formNum}-duration_minutes" value="${duration}" class="form-control" min="0" id="id_stages-${formNum}-duration_minutes">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Исполнитель</label>
                    <select name="stages-${formNum}-assigned_to" class="form-select" id="id_stages-${formNum}-assigned_to">
                        ${employeeOptions}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Должность</label>
                    <select name="stages-${formNum}-position_id" class="form-select position-select" id="id_stages-${formNum}-position_id">
                        ${positionOptions}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Порядок</label>
                    <input type="number" name="stages-${formNum}-order" value="${order}" class="form-control" min="0" id="id_stages-${formNum}-order">
                </div>
                <div class="col-md-1 d-flex align-items-end justify-content-center">
                    <div class="form-check mb-2">
                        <input type="checkbox" name="stages-${formNum}-DELETE" class="form-check-input" id="id_stages-${formNum}-DELETE">
                        <label class="form-check-label text-danger" for="id_stages-${formNum}-DELETE">
                            <i class="bi bi-trash"></i>
                        </label>
                    </div>
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Длительность (текст)</label>
                    <input type="text" name="stages-${formNum}-duration_text" value="${durationText}" class="form-control" maxlength="100" id="id_stages-${formNum}-duration_text">
                </div>
                <div class="col-md-8">
                    <label class="form-label small text-muted d-flex justify-content-between align-items-center">
                        <span>Материалы</span>
                        <button type="button" class="btn btn-sm btn-outline-primary edit-materials-btn" data-form-num="${formNum}">
                            <i class="bi bi-pencil"></i> Редактировать
                        </button>
                    </label>
                    <div class="materials-display small text-muted p-2 border rounded bg-white" data-form-num="${formNum}"></div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', formHtml);
    
    // Обновляем отображение материалов
    updateMaterialsDisplay(formNum, materials);
    
    // Показываем панель этапов
    updateStagesPanelVisibility();
}

// Фильтр "Показать все категории"
document.getElementById('showAllCategories').addEventListener('change', function() {
    // TODO: Реализовать фильтрацию шаблонов по категориям
    console.log('Фильтр изменен:', this.checked);
});

document.getElementById('add-stage').addEventListener('click', function() {
    const totalForms = document.getElementById('id_stages-TOTAL_FORMS');
    const formNum = parseInt(totalForms.value);
    
    addStageForm(formNum, {});
    
    totalForms.value = formNum + 1;
    
    // Обновляем видимость панели
    updateStagesPanelVisibility();
});

// Редактирование материалов
document.addEventListener('click', function(e) {
    if (e.target.closest('.edit-materials-btn')) {
        const btn = e.target.closest('.edit-materials-btn');
        currentEditingStageNum = btn.dataset.formNum;
        openMaterialsEditor(currentEditingStageNum);
    }
});

function openMaterialsEditor(formNum) {
    const materialsInput = document.getElementById(`id_stages-${formNum}-materials_info`);
    const materials = JSON.parse(materialsInput.value || '[]');
    
    const materialsList = document.getElementById('materials-list');
    materialsList.innerHTML = '';
    
    materials.forEach((material, index) => {
        addMaterialRow(index, material);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('materialsModal'));
    modal.show();
}

function addMaterialRow(index, material = {}) {
    const materialsList = document.getElementById('materials-list');
    
    const row = document.createElement('div');
    row.className = 'material-row mb-2 p-2 border rounded';
    row.dataset.index = index;
    
    // Формируем опции для выпадающего списка единиц измерения
    let unitOptions = '<option value="">-- Выберите ед.изм. --</option>';
    unitsData.forEach(unit => {
        const selected = unit.id == material.unit_id ? 'selected' : '';
        unitOptions += `<option value="${unit.id}" data-abbreviation="${unit.abbreviation}" ${selected}>${unit.name} (${unit.abbreviation})</option>`;
    });
    
    row.innerHTML = `
        <div class="row g-2">
            <div class="col-md-6">
                <select class="form-select material-select" data-index="${index}">
                    <option value="">-- Выберите материал --</option>
                    ${materialsData.map(m => `
                        <option value="${m.id}" data-name="${m.name}" data-unit-id="${m.unit_id}" data-unit-abbreviation="${m.unit_abbreviation}" ${m.id == material.id ? 'selected' : ''}>
                            ${m.name} (${m.code})
                        </option>
                    `).join('')}
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control material-quantity" placeholder="Количество" value="${material.quantity || ''}" step="0.01" min="0">
            </div>
            <div class="col-md-2">
                <select class="form-select material-unit" data-index="${index}">
                    ${unitOptions}
                </select>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-danger remove-material-btn">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    materialsList.appendChild(row);
    
    // Обработчик изменения материала
    row.querySelector('.material-select').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const unitSelect = row.querySelector('.material-unit');
        const unitId = selectedOption.dataset.unitId;
        
        // Устанавливаем правильную единицу измерения для материала
        if (unitId) {
            unitSelect.value = unitId;
        }
    });
    
    // Обработчик удаления
    row.querySelector('.remove-material-btn').addEventListener('click', function() {
        row.remove();
    });
}

document.getElementById('add-material-btn').addEventListener('click', function() {
    const materialsList = document.getElementById('materials-list');
    const index = materialsList.children.length;
    addMaterialRow(index);
});

document.getElementById('save-materials-btn').addEventListener('click', function() {
    const materials = [];
    document.querySelectorAll('.material-row').forEach(row => {
        const select = row.querySelector('.material-select');
        const quantity = row.querySelector('.material-quantity').value;
        const unitSelect = row.querySelector('.material-unit');
        
        if (select.value && quantity && unitSelect.value) {
            const selectedOption = select.options[select.selectedIndex];
            const unitOption = unitSelect.options[unitSelect.selectedIndex];
            materials.push({
                id: select.value,
                name: selectedOption.dataset.name,
                quantity: parseFloat(quantity),
                unit_id: unitSelect.value,
                unit: unitOption.dataset.abbreviation || unitOption.text
            });
        }
    });
    
    // Сохраняем в скрытое поле
    const materialsInput = document.getElementById(`id_stages-${currentEditingStageNum}-materials_info`);
    materialsInput.value = JSON.stringify(materials);
    
    // Обновляем отображение
    updateMaterialsDisplay(currentEditingStageNum, materials);
    
    // Закрываем модальное окно
    const modal = bootstrap.Modal.getInstance(document.getElementById('materialsModal'));
    modal.hide();
});
</script>
{% endblock %}
